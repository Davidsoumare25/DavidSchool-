<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DavidSchool Multi-Prof v12.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #6a00ff; --secondary: #1e90ff; --bg: #f2f4f8; --text: #222; --card-bg: #ffffff; }
        @media (prefers-color-scheme: dark) { :root { --bg: #121212; --text: #ffffff; --card-bg: #1e1e1e; } }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; }

        /* √âCRAN DE S√âLECTION PROFESSEUR */
        #prof-selector { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .prof-btn { width: 100%; max-width: 300px; padding: 18px; margin: 8px 0; border-radius: 15px; border: none; background: white; color: var(--primary); font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; font-size: 16px; }

        /* HEADER */
        header { background: linear-gradient(135deg, #1e004e, #6a00ff); color: white; padding: 35px 20px; text-align: center; position: relative; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; }
        .change-prof { position: absolute; left: 15px; top: 15px; font-size: 12px; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; cursor: pointer; }

        /* CONTENU */
        .grid { display: flex; flex-direction: column; gap: 15px; padding: 20px; max-width: 500px; margin: auto; }
        .card { padding: 25px; border-radius: 20px; color: white; font-weight: bold; border: none; background: linear-gradient(90deg, #6a00ff, #1e90ff); cursor: pointer; text-align: left; box-shadow: 0 4px 15px rgba(106, 0, 255, 0.2); }
        .exo-item { background: var(--card-bg); padding: 20px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.05); }

        .btn-p { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #ccc; background: var(--card-bg); color: var(--text); }

        #admin-page { display: none; padding: 20px; }
    </style>
</head>
<body>

    <div id="prof-selector">
        <div style="font-size: 50px; margin-bottom: 10px;">üéì</div>
        <h2 style="margin-bottom: 5px;">DavidSchool</h2>
        <p style="opacity: 0.7; margin-bottom: 25px;">S√©lectionnez votre professeur pour voir ses cours</p>
        <div id="prof-list" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
        <button onclick="showAdmin()" style="margin-top: 40px; background: none; border: none; color: var(--primary); font-weight: bold; text-decoration: underline;">Espace Enseignant</button>
    </div>

    <div id="user-page" style="display:none;">
        <header>
            <div class="change-prof" onclick="resetProfSelection()">üîÑ Changer de prof</div>
            <h1 style="margin:0; font-size: 22px;">DavidSchool</h1>
            <div id="prof-name-tag" style="font-size: 12px; opacity: 0.9; margin-top: 8px;">Professeur : ...</div>
        </header>
        <main id="content" class="grid"></main>
        <center><button id="backBtn" onclick="goBack()" style="display:none; margin-top: 20px; background: none; border: 2px solid var(--primary); color: var(--primary); padding: 10px 25px; border-radius: 10px; font-weight: bold;">‚¨Ö RETOUR</button></center>
    </div>

    <div id="admin-page">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="admin-title" style="margin:0">Admin</h2>
            <button onclick="location.reload()" style="border:none; background:none; color:red; font-weight:bold;">Quitter</button>
        </div>
        
        <div id="auth-area" class="exo-item">
            <p>Connectez-vous pour g√©rer vos cours.</p>
            <input type="text" id="prof-id-input" placeholder="Votre Nom (ex: M. David)">
            <input type="password" id="pass" placeholder="Code secret">
            <button class="btn-p" onclick="login()">Acc√©der √† mon espace</button>
        </div>

        <div id="admin-tools" style="display:none">
            <div class="exo-item">
                <h3>Ajouter un document</h3>
                <select id="aClass"></select>
                <select id="aSub"></select>
                <input id="aTitle" placeholder="Titre de la le√ßon">
                <input type="file" id="aFile">
                <button class="btn-p" id="upBtn" onclick="handleUpload()">üöÄ Publier pour mes √©l√®ves</button>
            </div>
            <div id="adminList" style="margin-top:20px;"></div>
        </div>
    </div>

<script>
    const S_URL = "https://lqevweyhxkvnckhtfpwh.supabase.co";
    const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxZXZ3ZXloeGt2bmNraHRmcHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTk2NTIsImV4cCI6MjA4NTYzNTY1Mn0.F6EUcdco3mn8AxlR9CMzxCmcxL-5-BypAhSak0JQSWw";
    const _db = supabase.createClient(S_URL, S_KEY);

    const CLASSES = ["6e", "5e", "4e", "3e"];
    const SUBS = ["MATH", "PHYSIQUE-CHIMIE", "SVT", "HISTOIRE-G√âO", "FRAN√áAIS"];
    let step = "classes", curC = "", curS = "", selectedProf = "";

    window.onload = () => {
        initSelectors();
        const savedProf = localStorage.getItem('davidschool_prof_choice');
        if(savedProf) startStudent(savedProf); else loadProfList();
    };

    async function loadProfList() {
        const { data } = await _db.from('exercises').select('professor_id');
        const uniqueProfs = [...new Set((data || []).map(p => p.professor_id))];
        const listDiv = document.getElementById('prof-list');
        listDiv.innerHTML = uniqueProfs.length ? "" : "<p>Aucun professeur n'a encore publi√© de cours.</p>";
        uniqueProfs.forEach(p => {
            let b = document.createElement('button');
            b.className = "prof-btn";
            b.innerText = p;
            b.onclick = () => startStudent(p);
            listDiv.appendChild(b);
        });
    }

    function startStudent(profName) {
        selectedProf = profName;
        localStorage.setItem('davidschool_prof_choice', profName);
        document.getElementById('prof-selector').style.display = 'none';
        document.getElementById('user-page').style.display = 'block';
        document.getElementById('prof-name-tag').innerText = "Professeur : " + profName;
        renderClasses();
    }

    function resetProfSelection() {
        localStorage.removeItem('davidschool_prof_choice');
        location.reload();
    }

    // --- NAVIGATION √âL√àVE ---
    function renderClasses() {
        step = "classes"; document.getElementById('backBtn').style.display='none';
        const c = document.getElementById('content'); c.innerHTML = "";
        CLASSES.forEach(cl => {
            let b = document.createElement('button'); b.className="card"; b.innerText="Classe de "+cl;
            b.onclick = () => { curC=cl; renderSubs(); }; c.appendChild(b);
        });
    }

    function renderSubs() {
        step = "subs"; document.getElementById('backBtn').style.display='block';
        const c = document.getElementById('content'); c.innerHTML = "";
        SUBS.forEach(s => {
            let b = document.createElement('button'); b.className="card"; b.innerText=s;
            b.onclick = () => { curS=s; renderExos(); }; c.appendChild(b);
        });
    }

    async function renderExos() {
        step = "exos";
        const c = document.getElementById('content'); c.innerHTML = "Chargement...";
        const { data } = await _db.from('exercises').select('*').eq('professor_id', selectedProf).eq('class', curC).eq('subject', curS);
        c.innerHTML = data && data.length ? "" : "Aucun cours disponible ici.";
        (data || []).forEach(e => {
            let d = document.createElement('div'); d.className="exo-item";
            d.innerHTML = `<b>${e.title}</b><br><br>
                <div style="display:flex; gap:10px;">
                    <a href="${e.file_url}" target="_blank" style="flex:1; text-align:center; background:var(--primary); color:white; padding:10px; border-radius:8px; text-decoration:none; font-size:14px;">üëÅÔ∏è Ouvrir</a>
                    <button onclick="downloadFile('${e.file_url}','${e.title}')" style="flex:1; background:#eee; border:none; padding:10px; border-radius:8px; cursor:pointer;">üì• T√©l√©charger</button>
                </div>`;
            c.appendChild(d);
        });
    }

    // --- LOGIQUE ADMIN ---
    function login() {
        const id = document.getElementById('prof-id-input').value.trim();
        const p = document.getElementById('pass').value;
        if(id.length < 3 || p !== "1234") return alert("Nom invalide ou code incorrect");
        selectedProf = id;
        document.getElementById('auth-area').style.display = 'none';
        document.getElementById('admin-tools').style.display = 'block';
        document.getElementById('admin-title').innerText = "Espace : " + id;
        refreshAdminList();
    }

    async function handleUpload() {
        const f = document.getElementById('aFile').files[0];
        const t = document.getElementById('aTitle').value;
        if(!f || !t) return alert("Veuillez remplir tous les champs");
        
        const btn = document.getElementById('upBtn'); btn.innerText = "‚è≥ Publication...";
        const path = Date.now() + "_" + f.name.replace(/\s/g, "_");
        
        try {
            await _db.storage.from('exercise-files').upload(path, f);
            const { data: u } = _db.storage.from('exercise-files').getPublicUrl(path);
            await _db.from('exercises').insert([{ 
                professor_id: selectedProf, class: document.getElementById('aClass').value, 
                subject: document.getElementById('aSub').value, title: t, 
                file_url: u.publicUrl, file_path: path, file_type: f.type.startsWith('image') ? 'img' : 'pdf'
            }]);
            alert("Publi√© !"); document.getElementById('aTitle').value=""; refreshAdminList();
        } catch(e) { alert("Erreur lors de l'envoi"); }
        btn.innerText = "üöÄ Publier pour mes √©l√®ves";
    }

    async function refreshAdminList() {
        const { data } = await _db.from('exercises').select('*').eq('professor_id', selectedProf);
        const l = document.getElementById('adminList');
        l.innerHTML = "<h4>Mes documents en ligne :</h4>";
        (data || []).forEach(e => {
            l.innerHTML += `<div style="padding:10px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:13px;">${e.class} | ${e.title}</span>
                <button onclick="del('${e.id}','${e.file_path}')" style="color:red; background:none; border:none; font-size:18px;">üóëÔ∏è</button>
            </div>`;
        });
    }

    async function del(id, p){ if(confirm("Supprimer ce document ?")){ await _db.from('exercises').delete().eq('id',id); refreshAdminList(); }}
    async function downloadFile(url, n){ const r=await fetch(url); const b=await r.blob(); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=n; a.click(); }
    function goBack(){ if(step==="exos") renderSubs(); else renderClasses(); }
    function showAdmin(){ document.getElementById('prof-selector').style.display='none'; document.getElementById('admin-page').style.display='block'; }
    function initSelectors(){ 
        CLASSES.forEach(cl=>document.getElementById('aClass').add(new Option(cl,cl))); 
        SUBS.forEach(s=>document.getElementById('aSub').add(new Option(s,s))); 
    }
</script>
</body>
</html>

