<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DavidSchool</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, Arial; background: #f2f4f8; color: #222; }
        header { background: linear-gradient(135deg, #6a00ff, #1e90ff); color: white; padding: 45px 22px; text-align: center; position: relative; }
        #adminIcon { position: absolute; top: 20px; left: 20px; width: 42px; height: 42px; border-radius: 50%; background: white; color: #6a00ff; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; }
        main { padding: 20px; max-width: 480px; margin: auto; }
        .grid { display: flex; flex-direction: column; gap: 16px; }
        .card { padding: 25px; border-radius: 20px; color: white; font-size: 22px; font-weight: bold; cursor: pointer; background: linear-gradient(135deg, #6a00ff, #1e90ff); box-shadow: 0 6px 15px rgba(0,0,0,0.15); text-align: left; text-transform: uppercase; }
        .exercise { padding: 20px; border-radius: 18px; margin-bottom: 15px; color: white; background: #333; }
        .exercise img { width: 100%; border-radius: 12px; margin-top: 10px; background: white; }
        button { margin-top: 10px; padding: 15px; border: none; border-radius: 12px; background: #6a00ff; color: white; font-size: 16px; width: 100%; cursor: pointer; }
        select, input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; }
        #adminModal, #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
        #adminBox { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; }
        .btn-quit { background: #ff4757; }
    </style>
</head>
<body>

<header>
    <div id="adminIcon">âš™</div>
    <h1>DavidSchool</h1>
</header>

<main>
    <div id="classes" class="grid"></div>
    <div id="subjects" class="grid" style="display:none"></div>
    <div id="exercises" class="grid" style="display:none"></div>
    
    <button id="backBtn" style="display:none; background:#888; margin-top:20px" onclick="goBack()">â¬… Retour</button>
</main>

<div id="adminModal">
    <div id="adminBox">
        <h2>Admin</h2>
        <div id="loginArea">
            <input type="password" id="loginPass" placeholder="Code (1234)">
            <button onclick="login()">Connexion</button>
            <button onclick="closeAdmin()" class="btn-quit">Annuler</button>
        </div>
        <div id="adminPanel" style="display:none">
            <select id="aClass"></select>
            <select id="aSubject"></select>
            <input id="aTitle" placeholder="Titre">
            <input type="file" id="aFile">
            <button onclick="addExercise()" id="uploadBtn">Envoyer</button>
            <button onclick="closeAdmin()" class="btn-quit">Quitter l'Admin</button>
        </div>
    </div>
</div>

<div id="overlay" onclick="this.style.display='none'"><img id="overlayImg" style="max-width:90%"></div>

<script>
// --- CONFIGURATION ---
const S_URL = "https://lqevweyhxkvnckhtfpwh.supabase.co";
const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxZXZ3ZXloeGt2bmNraHRmcHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTk2NTIsImV4cCI6MjA4NTYzNTY1Mn0.F6EUcdco3mn8AxlR9CMzxCmcxL-5-BypAhSak0JQSWw";
const _supabase = supabase.createClient(S_URL, S_KEY);

const matieres = ["Math", "Physique-Chimie", "Histoire", "GÃ©ographie", "FranÃ§ais", "SVT"];
const classesList = ["6e", "5e", "4e", "3e"];
let curClass="", curSubject="", isAdmin=false;

function loadClasses(){
    document.getElementById("classes").style.display = "flex";
    document.getElementById("subjects").style.display = "none";
    document.getElementById("exercises").style.display = "none";
    document.getElementById("backBtn").style.display = "none";
    
    const box = document.getElementById("classes");
    box.innerHTML = "";
    classesList.forEach(c => {
        let d = document.createElement("div");
        d.className = "card";
        d.innerText = c;
        d.onclick = () => { curClass=c; showSubjects(); };
        box.appendChild(d);
    });
}

function showSubjects(){
    document.getElementById("classes").style.display="none";
    document.getElementById("exercises").style.display="none";
    document.getElementById("subjects").style.display="flex";
    document.getElementById("backBtn").style.display="block";
    
    const box = document.getElementById("subjects");
    box.innerHTML = "";
    matieres.forEach(s => {
        let d = document.createElement("div");
        d.className = "card";
        d.innerText = s;
        d.onclick = () => { curSubject=s; fetchExercises(); };
        box.appendChild(d);
    });
}

async function fetchExercises(){
    document.getElementById("subjects").style.display="none";
    const box = document.getElementById("exercises");
    box.style.display="flex";
    box.innerHTML = "<p style='text-align:center'>Chargement...</p>";

    const { data, error } = await _supabase.from('exercises')
        .select('*').eq('class', curClass).eq('subject', curSubject);
    
    box.innerHTML = "";
    if(data && data.length > 0){
        data.forEach(e => {
            let div = document.createElement("div");
            div.className = "exercise";
            div.innerHTML = `<b>${e.title}</b>`;
            if(e.file_type === "img"){
                let img = document.createElement("img"); img.src = e.file_url;
                img.onclick = () => { document.getElementById("overlayImg").src=e.file_url; document.getElementById("overlay").style.display="flex"; };
                div.appendChild(img);
            } else {
                div.innerHTML += `<a href="${e.file_url}" target="_blank" style="color:#00d1ff;display:block;margin-top:10px;text-decoration:none;">ðŸ“¥ Ouvrir le document</a>`;
            }
            box.appendChild(div);
        });
    } else { box.innerHTML = "<p style='text-align:center'>Aucun exercice en " + curSubject + "</p>"; }
}

function goBack(){
    if(document.getElementById("exercises").style.display === "flex") showSubjects();
    else loadClasses();
}

document.getElementById("adminIcon").onclick = () => document.getElementById("adminModal").style.display="flex";
function closeAdmin() { document.getElementById("adminModal").style.display = "none"; }

function login(){
    if(document.getElementById("loginPass").value === "1234"){
        document.getElementById("loginArea").style.display="none";
        document.getElementById("adminPanel").style.display="block";
    }
}

async function addExercise(){
    const file = document.getElementById("aFile").files[0];
    const title = document.getElementById("aTitle").value;
    const btn = document.getElementById("uploadBtn");
    if(!file || !title) return alert("Remplis tout !");
    
    btn.innerText = "âŒ› Envoi...";
    btn.disabled = true;

    try {
        const cleanName = file.name.replace(/[^a-zA-Z0-9.]/g, "_");
        const path = `${curClass}/${Date.now()}_${cleanName}`;
        const { error: upErr } = await _supabase.storage.from('exercise-files').upload(path, file);
        if(upErr) throw upErr;

        const { data: urlData } = _supabase.storage.from('exercise-files').getPublicUrl(path);

        const { error: dbError } = await _supabase.from('exercises').insert([{
            class: document.getElementById("aClass").value,
            subject: document.getElementById("aSubject").value,
            title: title,
            file_url: urlData.publicUrl,
            file_path: path,
            file_type: file.type.startsWith("image") ? "img" : "doc"
        }]);

        if(dbError) throw dbError;
        alert("SuccÃ¨s !");
        location.reload();
    } catch(err) {
        alert("Erreur : " + err.message);
        btn.innerText = "Envoyer"; btn.disabled = false;
    }
}

const cSel = document.getElementById("aClass");
const sSel = document.getElementById("aSubject");
classesList.forEach(c => cSel.add(new Option(c,c)));
matieres.forEach(m => sSel.add(new Option(m,m)));

window.onload = loadClasses;
</script>
</body>
</html>

