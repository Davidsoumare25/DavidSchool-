<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DavidSchool</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#f4f7fb;
  --card:#ffffff;
  --hover:#d0e7ff;
  --back:#1e90ff;
  --exercise:#ffecb3;
  --lesson:#c8e6c9;
}

/* BASE */
body{margin:0; font-family:Arial,sans-serif; background:var(--bg);}
header{background:var(--back); color:white; padding:15px; text-align:center; font-size:22px;}
#adminIcon{position:fixed; top:10px; left:10px; background:white; color:var(--back); padding:8px 10px; border-radius:50%; cursor:pointer; font-weight:bold; z-index:2000;}
.container{padding:20px;}
.backBtn{background:var(--back); color:white; border:none; padding:6px 12px; margin-bottom:10px; border-radius:6px; cursor:pointer; display:none;}

/* CARDS */
.grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:15px;}
.card{padding:15px; border-radius:10px; text-align:center; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.1); transition:all .2s; color:white; font-weight:bold;}
.card:hover{transform:scale(1.05); opacity:0.9;}

/* CONTENT */
#subjects,#content{display:none;}
.columns{display:flex; gap:15px; flex-wrap:wrap;}
.column{flex:1; background:white; padding:10px; border-radius:10px; min-width:200px;}
.item{border-bottom:1px solid #eee; padding:8px; cursor:pointer; transition:all .2s;}
.item:hover{background:#f0f0f0;}
.item img{max-width:100%; border-radius:8px;}

/* POPUP */
#popup{display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:4000; justify-content:center; align-items:center;}
#popupBox{background:white; max-width:90%; max-height:90%; overflow:auto; padding:15px; border-radius:10px;}

/* ADMIN */
#adminModal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:3000;}
#adminBox{background:white; width:90%; max-width:400px; margin:60px auto; padding:15px; border-radius:10px;}
input,select,button{width:100%; margin:6px 0; padding:8px; box-sizing:border-box;}
</style>
</head>

<body>

<header>üìò DavidSchool</header>
<div id="adminIcon">‚öô</div>

<div class="container">

<button id="backBtn" class="backBtn" onclick="goBack()">‚Üê Retour</button>

<!-- CLASSES -->
<div id="classes" class="grid"></div>

<!-- MATI√àRES -->
<div id="subjects" class="grid"></div>

<!-- CONTENU -->
<div id="content" class="columns">
  <div class="column">
    <h3>üìÑ Exercices</h3>
    <div id="exercises"></div>
  </div>
  <div class="column">
    <h3>üìñ Le√ßons</h3>
    <div id="lessons"></div>
  </div>
</div>

</div>

<!-- POPUP -->
<div id="popup">
  <div id="popupBox"></div>
</div>

<!-- ADMIN -->
<div id="adminModal">
  <div id="adminBox">
    <h3>Admin</h3>
    <input type="password" id="adminPass" placeholder="Mot de passe">
    <button onclick="login()">Entrer</button>

    <div id="adminPanel" style="display:none">
      <select id="aClass"></select>
      <select id="aSubject">
        <option value="">Toutes les mati√®res (optionnel)</option>
      </select>
      <select id="aType">
        <option value="exercise">Exercice</option>
        <option value="lesson">Le√ßon</option>
      </select>
      <input id="aTitle" placeholder="Titre">
      <input type="file" id="aFile">
      <button onclick="addContent()">Ajouter</button>
    </div>

    <button onclick="closeAdmin()">Fermer</button>
  </div>
</div>

<script>
// SUPABASE
const SUPABASE_URL = "https://xwzjlddgqwlrxgetahvp.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3empsZGRncnhnZXRhaHZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MzY1NTQsImV4cCI6MjA4NTMxMjU1NH0.MsCgDKBz3jXrJ_dOcJ35koaLi-uBpNXoAoaFLAWDbkg";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// DOM
const adminIcon = document.getElementById("adminIcon");
const adminModal = document.getElementById("adminModal");
const adminPanel = document.getElementById("adminPanel");
const adminPass = document.getElementById("adminPass");
const classesBox = document.getElementById("classes");
const subjectsBox = document.getElementById("subjects");
const contentBox = document.getElementById("content");
const exercises = document.getElementById("exercises");
const lessons = document.getElementById("lessons");
const backBtn = document.getElementById("backBtn");
const popup = document.getElementById("popup");
const popupBox = document.getElementById("popupBox");
const aClass = document.getElementById("aClass");
const aSubject = document.getElementById("aSubject");
const aType = document.getElementById("aType");
const aTitle = document.getElementById("aTitle");
const aFile = document.getElementById("aFile");

// CLASSES et MATIERES
const classesData={
  "6e":["Math","Fran√ßais","Anglais","Histoire","G√©ographie","SVT"],
  "5e":["Math","Fran√ßais","Anglais","Histoire","G√©ographie","SVT"],
  "4e":["Math","Fran√ßais","Anglais","Histoire","G√©ographie","SVT","Physique-Chimie"],
  "3e":["Math","Fran√ßais","Anglais","Histoire","G√©ographie","SVT","Physique-Chimie"]
};
const classColors={"6e":"#f44336","5e":"#9c27b0","4e":"#2196f3","3e":"#ff9800"};
const subjectColors={"Math":"#3f51b5","Fran√ßais":"#e91e63","Anglais":"#009688","Histoire":"#795548","G√©ographie":"#4caf50","SVT":"#ff5722","Physique-Chimie":"#607d8b"};

let currentClass="", currentSubject="";

// INIT CLASSES et ADMIN select
function initClasses(){
  classesBox.innerHTML="";
  aClass.innerHTML="";
  aSubject.innerHTML='<option value="">Toutes les mati√®res (optionnel)</option>';
  Object.keys(classesData).forEach(c=>{
    const card=document.createElement("div");
    card.className="card";
    card.textContent=c;
    card.style.background=classColors[c] || "#333";
    card.onclick=()=>selectClass(c);
    classesBox.appendChild(card);

    const opt=document.createElement("option"); opt.value=c; opt.textContent=c;
    aClass.appendChild(opt);
  });

  // Remplir mati√®res dans admin
  const allSubjects=[...new Set(Object.values(classesData).flat())];
  allSubjects.forEach(m=>{
    const opt=document.createElement("option"); opt.value=m; opt.textContent=m;
    aSubject.appendChild(opt);
  });
}
initClasses();

function showBack(){backBtn.style.display="inline-block";}
function hideBack(){backBtn.style.display="none";}
function goBack(){
  if(contentBox.style.display=="flex"){
    contentBox.style.display="none"; subjectsBox.style.display="grid"; showBack();
  }else if(subjectsBox.style.display=="grid"){
    subjectsBox.style.display="none"; classesBox.style.display="grid"; hideBack();
  }
}

// SELECTION CLASSE ‚Üí MATIERE
function selectClass(c){
  currentClass=c; classesBox.style.display="none";
  subjectsBox.innerHTML="";
  classesData[c].forEach(m=>{
    const card=document.createElement("div");
    card.className="card";
    card.textContent=m;
    card.style.background=subjectColors[m] || "#555";
    card.onclick=()=>selectSubject(m);
    subjectsBox.appendChild(card);
  });
  subjectsBox.style.display="grid"; showBack();
}

function selectSubject(m){
  currentSubject=m; subjectsBox.style.display="none"; contentBox.style.display="flex"; loadContent(); showBack();
}

// CHARGEMENT CONTENU
async function loadContent(){
  exercises.innerHTML=""; lessons.innerHTML="";
  const {data,error}=await db.from("contents").select("*")
    .eq("classe",currentClass)
    .eq("matiere",currentSubject || "");
  if(error){console.log(error); return;}
  data.forEach(d=>{
    const div=document.createElement("div");
    div.className="item";
    div.textContent=d.title;
    div.onclick=()=>{
      popupBox.innerHTML = d.file_url.endsWith(".pdf") 
        ? `<iframe src="${d.file_url}" style="width:100%;height:80vh"></iframe>` 
        : `<img src="${d.file_url}" style="width:100%">`;
      popup.style.display="flex";
    };
    (d.type==="exercise"?exercises:lessons).appendChild(div);
  });
}
popup.onclick=()=>popup.style.display="none";

// ADMIN
adminIcon.addEventListener("click",()=>adminModal.style.display="block");
function closeAdmin(){adminModal.style.display="none";}
function login(){if(adminPass.value==="1234") adminPanel.style.display="block"; else alert("Mot de passe incorrect !");}

// AJOUT CONTENU
async function addContent(){
  const file=aFile.files[0]; if(!file){alert("S√©lectionne un fichier !"); return;}
  const path=Date.now()+"_"+file.name;
  await db.storage.from("davidschool").upload(path,file);
  const {data:{publicUrl}}=db.storage.from("davidschool").getPublicUrl(path);
  await db.from("contents").insert({
    classe:aClass.value,
    matiere:aSubject.value || "",
    type:aType.value,
    title:aTitle.value,
    file_url:publicUrl
  });
  alert("Ajout√© !"); aTitle.value=""; aFile.value="";
}
</script>
</body>
</html>
