<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DavidSchool Pro v19</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p: #6a00ff; --s: #1e90ff; --bg: #f2f4f8; --card: #ffffff; --txt: #222; }
        @media (prefers-color-scheme: dark) { :root { --bg: #121212; --card: #1e1e1e; --txt: #ffffff; } }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--txt); }
        
        header { background: linear-gradient(135deg, #1e004e, #6a00ff); color: white; padding: 25px; text-align: center; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; position: relative; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 15px; padding: 15px; max-width: 500px; margin: auto; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); position: relative; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; background: var(--p); color: white; margin-top: 10px; }
        .hidden { display: none !important; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; background: var(--card); color: var(--txt); }
        
        /* Style sp√©cial Annonce */
        .announcement-box { background: #fff3cd; border-left: 5px solid #ffc107; color: #856404; padding: 15px; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
    </style>
</head>
<body>

    <div id="scr-auth" class="grid" style="margin-top: 50px;">
        <div class="card">
            <h2 style="text-align:center; color:var(--p)">DavidSchool</h2>
            <input type="text" id="u-name" placeholder="Nom complet">
            <input type="password" id="u-pass" placeholder="Mot de passe">
            <div id="reg-box" class="hidden">
                <select id="u-role"><option value="student">√âl√®ve</option><option value="teacher">Professeur</option></select>
                <input type="text" id="u-code" placeholder="Code de classe">
            </div>
            <button class="btn" onclick="handleAuth()" id="btn-auth">Entrer</button>
            <p onclick="toggleAuth()" style="text-align:center; font-size:12px; cursor:pointer; text-decoration:underline; margin-top:15px;">S'inscrire / Se connecter</p>
        </div>
    </div>

    <div id="scr-prof" class="hidden">
        <header><div style="position:absolute; right:20px; top:20px;" onclick="location.reload()">üö™</div><h2>Espace Prof</h2></header>
        <div class="grid">
            <div class="card">
                <h3>üì§ Publier un cours</h3>
                <input type="text" id="p-title" placeholder="Titre (ex: Devoir Maison n¬∞1)">
                <textarea id="p-ann" placeholder="Ajouter une annonce/consigne (Optionnel)"></textarea>
                <select id="p-class"><option>6e</option><option>5e</option><option>4e</option><option>3e</option></select>
                <select id="p-sub"><option>MATHS</option><option>SVT</option><option>PC</option><option>HISTOIRE-G√âO</option></select>
                <input type="file" id="p-file">
                <button class="btn" onclick="upload()" id="btn-pub">üöÄ Publier</button>
            </div>
            <div id="prof-list"></div>
        </div>
    </div>

    <div id="scr-student" class="hidden">
        <header><div style="position:absolute; right:20px; top:20px;" onclick="location.reload()">üö™</div><h2 id="stu-head">Mes Cours</h2></header>
        <div id="view-teachers" class="grid"></div>
        <div id="view-classes" class="grid hidden"><button onclick="showTeachers()" class="btn" style="background:gray">‚¨Ö Retour</button><div id="classes-list"></div></div>
        <div id="view-subs" class="grid hidden"><button onclick="showClassesNav()" class="btn" style="background:gray">‚¨Ö Retour</button><div id="subs-list"></div></div>
        <div id="view-files" class="grid hidden">
            <button onclick="showSubsNav()" class="btn" style="background:gray">‚¨Ö Retour</button>
            <div id="files-list"></div>
        </div>
    </div>

<script>
    const S_URL = "https://lqevweyhxkvnckhtfpwh.supabase.co";
    const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxZXZ3ZXloeGt2bmNraHRmcHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTk2NTIsImV4cCI6MjA4NTYzNTY1Mn0.F6EUcdco3mn8AxlR9CMzxCmcxL-5-BypAhSak0JQSWw";
    const _db = supabase.createClient(S_URL, S_KEY);

    let user = null, isLogin = true, curCode = "", curClass = "", curSub = "";

    function toggleAuth() { isLogin = !isLogin; document.getElementById('reg-box').classList.toggle('hidden', isLogin); }

    async function handleAuth() {
        const n = document.getElementById('u-name').value.trim(), p = document.getElementById('u-pass').value;
        if(isLogin) {
            const { data } = await _db.from('users_profile').select('*').eq('full_name', n).eq('password', p).maybeSingle();
            if(!data) return alert("Identifiants incorrects");
            user = data; start();
        } else {
            const r = document.getElementById('u-role').value, c = document.getElementById('u-code').value.trim();
            await _db.from('users_profile').insert([{ full_name:n, password:p, role:r, class_code:[c] }]);
            alert("Compte cr√©√© !"); toggleAuth();
        }
    }

    function start() {
        document.getElementById('scr-auth').classList.add('hidden');
        if(user.role === 'teacher') { document.getElementById('scr-prof').classList.remove('hidden'); loadProfDocs(); }
        else { document.getElementById('scr-student').classList.remove('hidden'); renderTeachers(); }
    }

    async function upload() {
        const f = document.getElementById('p-file').files[0], t = document.getElementById('p-title').value, a = document.getElementById('p-ann').value;
        if(!f || !t) return alert("Titre et fichier requis");
        const b = document.getElementById('btn-pub'); b.innerText = "Envoi...";
        const path = Date.now() + "_" + f.name.replace(/\s/g, "_");
        await _db.storage.from('exercise-files').upload(path, f);
        const { data: u } = _db.storage.from('exercise-files').getPublicUrl(path);
        
        await _db.from('exercises').insert([{
            professor_id: user.full_name, title: t, announcement: a,
            class: document.getElementById('p-class').value, subject: document.getElementById('p-sub').value,
            file_url: u.publicUrl, class_code: user.class_code[0]
        }]);
        alert("Publi√© !"); loadProfDocs(); b.innerText = "üöÄ Publier";
    }

    async function loadProfDocs() {
        // .order('created_at', { ascending: false }) permet de mettre le plus r√©cent en haut
        const { data } = await _db.from('exercises').select('*').eq('class_code', user.class_code[0]).order('created_at', { ascending: false });
        const list = document.getElementById('prof-list');
        list.innerHTML = "<h4>Vos publications (R√©cent en haut) :</h4>";
        data.forEach(d => { list.innerHTML += `<div class="card"><b>${d.class}</b> - ${d.title} <button onclick="delDoc('${d.id}')" style="float:right; color:red; border:none; background:none; cursor:pointer">üóëÔ∏è</button></div>`; });
    }

    async function delDoc(id) { if(confirm("Supprimer ?")) { await _db.from('exercises').delete().eq('id', id); loadProfDocs(); } }

    function renderTeachers() {
        const div = document.getElementById('view-teachers'); div.innerHTML = "<h3>Choisir un prof</h3>";
        user.class_code.forEach(c => { div.innerHTML += `<div class="card" onclick="openTeacher('${c}')">üë®‚Äçüè´ Professeur : ${c}</div>`; });
    }

    function openTeacher(code) { curCode = code; showClassesNav(); }
    function showClassesNav() { hideAllNav(); document.getElementById('view-classes').classList.remove('hidden'); 
        const div = document.getElementById('classes-list'); div.innerHTML = "<h3>Choisir la classe</h3>";
        ["6e","5e","4e","3e"].forEach(cl => { div.innerHTML += `<div class="card" onclick="openClass('${cl}')">üìÇ Classe de ${cl}</div>`; });
    }
    function openClass(cl) { curClass = cl; showSubsNav(); }
    function showSubsNav() { hideAllNav(); document.getElementById('view-subs').classList.remove('hidden');
        const div = document.getElementById('subs-list'); div.innerHTML = "<h3>Mati√®res</h3>";
        ["MATHS","SVT","PC","HISTOIRE-G√âO"].forEach(s => { div.innerHTML += `<div class="card" onclick="openSub('${s}')">üìñ ${s}</div>`; });
    }
    function openSub(s) { curSub = s; showFilesNav(); }

    async function showFilesNav() {
        hideAllNav(); document.getElementById('view-files').classList.remove('hidden');
        const div = document.getElementById('files-list'); div.innerHTML = "Chargement...";
        // On trie aussi ici : .order('created_at', { ascending: false })
        const { data } = await _db.from('exercises').select('*').eq('class_code', curCode).eq('class', curClass).eq('subject', curSub).order('created_at', { ascending: false });
        div.innerHTML = data.length ? "" : "Aucun cours.";
        data.forEach(f => {
            let annHtml = f.announcement ? `<div class="announcement-box"><b>Annonce :</b> ${f.announcement}</div>` : "";
            div.innerHTML += `<div class="card">${annHtml}<h4>${f.title}</h4><button class="btn" onclick="window.open('${f.file_url}', '_blank')">üëÅÔ∏è Ouvrir le document</button></div>`;
        });
    }

    function hideAllNav() { ['view-teachers','view-classes','view-subs','view-files'].forEach(id => document.getElementById(id).classList.add('hidden')); }
    function showTeachers() { hideAllNav(); document.getElementById('view-teachers').classList.remove('hidden'); }
</script>
</body>
</html>
