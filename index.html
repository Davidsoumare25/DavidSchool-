<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DavidSchool Pro v22</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p: #1e90ff; --s: #6a00ff; --bg: #f4f7f6; --card: #ffffff; --txt: #333; }
        @media (prefers-color-scheme: dark) { :root { --bg: #1a1a1a; --card: #2d2d2d; --txt: #eee; } }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--txt); }
        header { background: linear-gradient(135deg, var(--s), var(--p)); color: white; padding: 30px 20px; text-align: center; border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 15px; padding: 20px; max-width: 600px; margin: auto; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); }
        .folder { display: flex; align-items: center; justify-content: space-between; background: var(--card); padding: 18px; border-radius: 12px; border-left: 8px solid var(--p); cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: var(--p); color: white; margin-top: 10px; font-size: 16px; }
        .btn-edit { background: #ffa500; margin-top: 5px; padding: 8px; font-size: 12px; }
        .btn-red { background: #eb4d4b; margin-top: 5px; padding: 8px; font-size: 12px; }
        .hidden { display: none !important; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; background: var(--card); color: var(--txt); }
        .announcement { background: #fff4e6; border: 1px solid #ffd8a8; color: #d9480f; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .nav-back { color: var(--p); font-weight: bold; cursor: pointer; display: inline-block; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="scr-auth" class="grid" style="margin-top: 50px;">
        <div class="card" style="text-align: center;">
            <h1 style="color: var(--s);">DavidSchool</h1>
            <input type="text" id="u-name" placeholder="Nom d'utilisateur">
            <input type="password" id="u-pass" placeholder="Mot de passe">
            <div id="reg-box" class="hidden">
                <select id="u-role"><option value="student">üë®‚Äçüéì √âl√®ve</option><option value="teacher">üë®‚Äçüè´ Professeur</option></select>
                <input type="text" id="u-code" placeholder="Code (ex: CLASSE01)">
            </div>
            <button class="btn" onclick="handleAuth()" id="btn-auth">Se connecter</button>
            <p onclick="toggleAuth()" style="font-size: 13px; cursor: pointer; text-decoration: underline; margin-top: 20px;">Cr√©er un compte</p>
        </div>
    </div>

    <div id="scr-prof" class="hidden">
        <header><div style="position:absolute; right:20px; top:20px;" onclick="location.reload()">üö™</div><h2>Espace Prof</h2></header>
        <div class="grid">
            <div class="card" id="form-prof">
                <h3 id="form-title">üì§ Publier un Cours</h3>
                <input type="hidden" id="edit-id">
                <input type="text" id="p-title" placeholder="Titre du document">
                <textarea id="p-ann" placeholder="Annonce ou consigne..."></textarea>
                <select id="p-class"><option value="6e">6√®me</option><option value="5e">5√®me</option><option value="4e">4√®me</option><option value="3e">3√®me</option></select>
                <select id="p-sub"><option value="FRAN√áAIS">üá´üá∑ FRAN√áAIS</option><option value="MATHS">üìê MATHS</option><option value="SVT">üß¨ SVT</option><option value="PC">üß™ PHYSIQUE-CHIMIE</option><option value="HG">üåç HISTOIRE-G√âO</option></select>
                <p id="file-status" style="font-size:11px; color:orange;" class="hidden">Note : Laissez vide pour garder l'ancien fichier</p>
                <input type="file" id="p-file">
                <button class="btn" onclick="upload()" id="btn-pub">üöÄ Publier maintenant</button>
                <button class="btn hidden" id="btn-cancel" onclick="cancelEdit()" style="background:gray">Annuler la modification</button>
            </div>
            <div id="prof-list"></div>
        </div>
    </div>

    <div id="scr-student" class="hidden">
        <header><div style="position:absolute; right:20px; top:20px;" onclick="location.reload()">üö™</div><h2>Mes Cours</h2></header>
        <div id="step-teachers" class="grid"></div>
        <div id="step-classes" class="grid hidden"><span class="nav-back" onclick="showStep('step-teachers')">‚¨Ö Retour</span><div id="list-classes"></div></div>
        <div id="step-subs" class="grid hidden"><span class="nav-back" onclick="stepBack('step-classes')">‚¨Ö Retour</span><div id="list-subs"></div></div>
        <div id="step-files" class="grid hidden"><span class="nav-back" onclick="stepBack('step-subs')">‚¨Ö Retour</span><div id="list-files"></div></div>
    </div>

<script>
    const S_URL = "https://lqevweyhxkvnckhtfpwh.supabase.co";
    const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxZXZ3ZXloeGt2bmNraHRmcHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTk2NTIsImV4cCI6MjA4NTYzNTY1Mn0.F6EUcdco3mn8AxlR9CMzxCmcxL-5-BypAhSak0JQSWw";
    const _db = supabase.createClient(S_URL, S_KEY);

    let user = null, isLogin = true, selCode = "", selClass = "", selSub = "", isEditing = false;

    function toggleAuth() { isLogin = !isLogin; document.getElementById('reg-box').classList.toggle('hidden', isLogin); }
    async function handleAuth() {
        const n = document.getElementById('u-name').value.trim(), p = document.getElementById('u-pass').value;
        if(isLogin) {
            const { data } = await _db.from('users_profile').select('*').eq('full_name', n).eq('password', p).maybeSingle();
            if(!data) return alert("Erreur identifiants");
            user = data; start();
        } else {
            const r = document.getElementById('u-role').value, c = document.getElementById('u-code').value.trim();
            await _db.from('users_profile').insert([{ full_name:n, password:p, role:r, class_code:[c] }]);
            alert("Compte cr√©√© !"); location.reload();
        }
    }

    function start() {
        document.getElementById('scr-auth').classList.add('hidden');
        if(user.role === 'teacher') { document.getElementById('scr-prof').classList.remove('hidden'); loadProfDocs(); }
        else { document.getElementById('scr-student').classList.remove('hidden'); renderTeachers(); }
    }

    // --- PROFESSEUR (PUBLIER & MODIFIER) ---
    async function upload() {
        const f = document.getElementById('p-file').files[0], t = document.getElementById('p-title').value, 
              a = document.getElementById('p-ann').value, id = document.getElementById('edit-id').value;
        
        if(!t) return alert("Le titre est obligatoire");
        const b = document.getElementById('btn-pub'); b.innerText = "‚è≥ Patientez...";

        let finalUrl = null;
        if(f) {
            const name = Date.now() + "_" + f.name.replace(/\s/g, "_");
            await _db.storage.from('exercise-files').upload(name, f);
            finalUrl = _db.storage.from('exercise-files').getPublicUrl(name).data.publicUrl;
        }

        if(isEditing) {
            const updateData = { title: t, announcement: a, class: document.getElementById('p-class').value, subject: document.getElementById('p-sub').value };
            if(finalUrl) updateData.file_url = finalUrl;
            await _db.from('exercises').update(updateData).eq('id', id);
            alert("Modifi√© !");
            cancelEdit();
        } else {
            if(!f) return alert("Veuillez choisir un fichier pour une nouvelle publication");
            await _db.from('exercises').insert([{ professor_id: user.full_name, title: t, announcement: a, class: document.getElementById('p-class').value, subject: document.getElementById('p-sub').value, file_url: finalUrl, class_code: user.class_code[0] }]);
            alert("Publi√© !");
        }
        loadProfDocs();
        b.innerText = isEditing ? "üíæ Enregistrer" : "üöÄ Publier";
    }

    async function loadProfDocs() {
        const { data } = await _db.from('exercises').select('*').eq('class_code', user.class_code[0]).order('created_at', { ascending: false });
        const list = document.getElementById('prof-list');
        list.innerHTML = "<h4>Vos cours (R√©cent en haut) :</h4>";
        data.forEach(d => {
            list.innerHTML += `<div class="card" style="margin-bottom:10px">
                <b>[${d.class}]</b> ${d.title} <br><small>${d.subject}</small><br>
                <button class="btn btn-edit" onclick='prepEdit(${JSON.stringify(d)})'>‚úèÔ∏è Modifier</button>
                <button class="btn btn-red" onclick="delDoc('${d.id}')">üóëÔ∏è Supprimer</button>
            </div>`;
        });
    }

    function prepEdit(doc) {
        isEditing = true;
        document.getElementById('form-title').innerText = "‚úèÔ∏è Modifier le cours";
        document.getElementById('edit-id').value = doc.id;
        document.getElementById('p-title').value = doc.title;
        document.getElementById('p-ann').value = doc.announcement || "";
        document.getElementById('p-class').value = doc.class;
        document.getElementById('p-sub').value = doc.subject;
        document.getElementById('btn-pub').innerText = "üíæ Enregistrer les modifications";
        document.getElementById('btn-cancel').classList.remove('hidden');
        document.getElementById('file-status').classList.remove('hidden');
        window.scrollTo(0,0);
    }

    function cancelEdit() {
        isEditing = false;
        document.getElementById('form-title').innerText = "üì§ Publier un Cours";
        document.getElementById('edit-id').value = "";
        document.getElementById('p-title').value = "";
        document.getElementById('p-ann').value = "";
        document.getElementById('btn-pub').innerText = "üöÄ Publier maintenant";
        document.getElementById('btn-cancel').classList.add('hidden');
        document.getElementById('file-status').classList.add('hidden');
    }

    async function delDoc(id) { if(confirm("Supprimer ?")) { await _db.from('exercises').delete().eq('id', id); loadProfDocs(); } }

    // --- ELEVE (NAVIGATION) ---
    function showStep(s) { document.querySelectorAll('.grid').forEach(g => { if(g.id.startsWith('step')) g.classList.add('hidden'); }); document.getElementById(s).classList.remove('hidden'); }
    function renderTeachers() {
        const div = document.getElementById('step-teachers'); div.innerHTML = "<h3>Profs</h3>";
        user.class_code.forEach(code => { div.innerHTML += `<div class="folder" onclick="selCode='${code}'; showStep('step-classes'); renderClasses();">üë®‚Äçüè´ Prof : ${code} ‚û°</div>`; });
    }
    function renderClasses() {
        const div = document.getElementById('list-classes'); div.innerHTML = "<h3>Classes</h3>";
        ["6e","5e","4e","3e"].forEach(c => { div.innerHTML += `<div class="folder" onclick="selClass='${c}'; showStep('step-subs'); renderSubs();">üìÇ ${c} ‚û°</div>`; });
    }
    function renderSubs() {
        const div = document.getElementById('list-subs'); div.innerHTML = "<h3>Mati√®res</h3>";
        ["FRAN√áAIS", "MATHS", "SVT", "PC", "HG"].forEach(s => { div.innerHTML += `<div class="folder" onclick="selSub='${s}'; showStep('step-files'); renderFiles();">üìñ ${s} ‚û°</div>`; });
    }
    async function renderFiles() {
        const div = document.getElementById('list-files'); div.innerHTML = "Chargement...";
        const { data } = await _db.from('exercises').select('*').eq('class_code', selCode).eq('class', selClass).eq('subject', selSub).order('created_at', { ascending: false });
        div.innerHTML = data.length ? "" : "Aucun document.";
        data.forEach(f => {
            let ann = f.announcement ? `<div class="announcement">üì¢ ${f.announcement}</div>` : "";
            div.innerHTML += `<div class="card" style="margin-bottom:15px;">${ann}<h4>${f.title}</h4><a href="${f.file_url}" target="_blank" class="btn">üì• Ouvrir</a></div>`;
        });
    }
    function stepBack(s) { showStep(s); }
</script>
</body>
</html>

