<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DavidSchool</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Styles G√©n√©raux */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, Arial; background: #f2f4f8; color: #222; overflow-x: hidden; } /* Emp√™che le d√©filement horizontal */
        
        /* Animation Bienvenue */
        #welcome-animation {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #6a00ff, #1e90ff); /* Ton d√©grad√© */
            color: white;
            display: flex; justify-content: center; align-items: center;
            font-size: 3em; font-weight: bold;
            z-index: 9999;
            opacity: 1;
            transition: opacity 1.5s ease-out 1.5s, transform 1.5s ease-out 1.5s; /* Transition apr√®s un d√©lai */
            transform: scale(1);
        }
        #welcome-animation.fade-out {
            opacity: 0;
            transform: scale(1.1); /* Petit zoom arri√®re pour l'effet */
            pointer-events: none; /* Emp√™che les clics une fois disparu */
        }

        /* Header */
        header { background: linear-gradient(135deg, #6a00ff, #1e90ff); color: white; padding: 30px 20px; text-align: center; position: relative; }
        .logo-img { height: 70px; margin-bottom: 10px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #adminIcon { position: absolute; top: 20px; left: 20px; width: 42px; height: 42px; border-radius: 50%; background: white; color: #6a00ff; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* Contenu Principal */
        main { padding: 20px; max-width: 480px; margin: auto; }
        .grid { display: flex; flex-direction: column; gap: 16px; }
        .card { padding: 25px; border-radius: 20px; color: white; font-size: 22px; font-weight: bold; cursor: pointer; background: linear-gradient(135deg, #6a00ff, #1e90ff); box-shadow: 0 6px 15px rgba(0,0,0,0.15); text-align: left; text-transform: uppercase; transition: 0.2s; }
        .card:hover { transform: scale(1.02); }
        .exercise { padding: 20px; border-radius: 18px; margin-bottom: 15px; color: white; background: #333; position: relative; }
        .exercise img { width: 100%; border-radius: 12px; margin-top: 10px; background: white; cursor: pointer; }
        
        /* Boutons & Inputs */
        button { margin-top: 10px; padding: 15px; border: none; border-radius: 12px; background: #6a00ff; color: white; font-size: 16px; width: 100%; cursor: pointer; }
        select, input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; }
        
        /* Modale Admin */
        #adminModal, #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
        #adminBox { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; }
        
        /* Boutons sp√©cifiques */
        .btn-quit { background: #ff4757; }
        .btn-delete { background: #ff4757; font-size: 14px; padding: 8px; margin-top: 15px; }
    </style>
</head>
<body>

<div id="welcome-animation">Bienvenue dans DavidSchool</div>

<header>
    <div id="adminIcon">‚öô</div>
    <img src="https://lqevweyhxkvnckhtfpwh.supabase.co/storage/v1/object/public/exercise-files/1769899198248.png" alt="Logo DavidSchool" class="logo-img">
    <h1 style="margin:0; font-size: 28px;">DavidSchool</h1>
</header>

<main>
    <div id="classes" class="grid"></div>
    <div id="subjects" class="grid" style="display:none"></div>
    <div id="exercises" class="grid" style="display:none"></div>
    <button id="backBtn" style="display:none; background:#888; margin-top:20px" onclick="goBack()">‚¨Ö Retour</button>
</main>

<div id="adminModal">
    <div id="adminBox">
        <h2>Administration</h2>
        <div id="loginArea">
            <input type="password" id="loginPass" placeholder="Code Secret (1234)">
            <button onclick="login()">Connexion</button>
            <button onclick="closeAdmin()" class="btn-quit">Annuler</button>
        </div>
        <div id="adminPanel" style="display:none">
            <label>Classe :</label>
            <select id="aClass"></select>
            <label>Mati√®re :</label>
            <select id="aSubject"></select>
            <input id="aTitle" placeholder="Titre de l'exercice">
            <input type="file" id="aFile">
            <button onclick="addExercise()" id="uploadBtn">üöÄ Envoyer l'exercice</button>
            <button onclick="closeAdmin()" class="btn-quit">Quitter l'Admin</button>
        </div>
    </div>
</div>

<div id="overlay" onclick="this.style.display='none'"><img id="overlayImg" style="max-width:90%; border-radius:10px;"></div>

<script>
// --- CONFIGURATION ---
const S_URL = "https://lqevweyhxkvnckhtfpwh.supabase.co";
const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxZXZ3ZXloeGt2bmNraHRmcHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTk2NTIsImV4cCI6MjA4NTYzNTY1Mn0.F6EUcdco3mn8AxlR9CMzxCmcxL-5-BypAhSak0JQSWw";
const _supabase = supabase.createClient(S_URL, S_KEY);

const matieres = ["Math", "Physique-Chimie", "Histoire", "G√©ographie", "Fran√ßais", "SVT"];
const classesList = ["6e", "5e", "4e", "3e"];
let curClass="", curSubject="", isAdmin=false;

// Fonctionnalit√©s de navigation
function loadClasses(){
    document.getElementById("classes").style.display = "flex";
    document.getElementById("subjects").style.display = "none";
    document.getElementById("exercises").style.display = "none";
    document.getElementById("backBtn").style.display = "none";
    const box = document.getElementById("classes");
    box.innerHTML = "";
    classesList.forEach(c => {
        let d = document.createElement("div"); d.className = "card"; d.innerText = c;
        d.onclick = () => { curClass=c; showSubjects(); };
        box.appendChild(d);
    });
}

function showSubjects(){
    document.getElementById("classes").style.display="none";
    document.getElementById("exercises").style.display="none";
    document.getElementById("subjects").style.display="flex";
    document.getElementById("backBtn").style.display="block";
    const box = document.getElementById("subjects");
    box.innerHTML = "";
    matieres.forEach(s => {
        let d = document.createElement("div"); d.className = "card"; d.innerText = s;
        d.onclick = () => { curSubject=s; fetchExercises(); };
        box.appendChild(d);
    });
}

async function fetchExercises(){
    document.getElementById("subjects").style.display="none";
    const box = document.getElementById("exercises");
    box.style.display="flex";
    box.innerHTML = "<p style='text-align:center'>Chargement...</p>";

    const { data, error } = await _supabase.from('exercises')
        .select('*').eq('class', curClass).eq('subject', curSubject);
    
    box.innerHTML = "";
    if(data && data.length > 0){
        data.forEach(e => {
            let div = document.createElement("div");
            div.className = "exercise";
            div.innerHTML = `<b>${e.title}</b>`;
            if(e.file_type === "img"){
                let img = document.createElement("img"); img.src = e.file_url;
                img.onclick = () => { document.getElementById("overlayImg").src=e.file_url; document.getElementById("overlay").style.display="flex"; };
                div.appendChild(img);
            } else {
                div.innerHTML += `<a href="${e.file_url}" target="_blank" style="color:#00d1ff;display:block;margin-top:10px;text-decoration:none;">üì• Ouvrir document</a>`;
            }

            // BOUTON SUPPRIMER (Admin seulement)
            if(isAdmin){
                let delBtn = document.createElement("button");
                delBtn.className = "btn-delete";
                delBtn.innerText = "üóë Supprimer";
                delBtn.onclick = async () => {
                    if(confirm("Supprimer d√©finitivement cet exercice ?")){
                        await _supabase.from('exercises').delete().eq('id', e.id);
                        await _supabase.storage.from('exercise-files').remove([e.file_path]);
                        fetchExercises(); // Rafra√Æchir la liste apr√®s suppression
                    }
                };
                div.appendChild(delBtn);
            }
            box.appendChild(div);
        });
    } else { box.innerHTML = "<p style='text-align:center'>Aucun exercice en " + curSubject + "</p>"; }
}

function goBack(){
    if(document.getElementById("exercises").style.display === "flex") showSubjects();
    else loadClasses();
}

// Fonctionnalit√©s Admin
document.getElementById("adminIcon").onclick = () => document.getElementById("adminModal").style.display="flex";
function closeAdmin() { document.getElementById("adminModal").style.display = "none"; }

function login(){
    if(document.getElementById("loginPass").value === "1234"){
        isAdmin = true;
        document.getElementById("loginArea").style.display="none";
        document.getElementById("adminPanel").style.display="block";
        loadClasses(); // Rafra√Æchir pour activer les boutons supprimer si besoin
    } else { alert("Code incorrect"); }
}

async function addExercise(){
    const file = document.getElementById("aFile").files[0];
    const title = document.getElementById("aTitle").value;
    const btn = document.getElementById("uploadBtn");
    if(!file || !title) return alert("Remplis le titre et choisis un fichier");
    btn.innerText = "‚åõ Envoi..."; btn.disabled = true;

    try {
        const cleanName = file.name.replace(/[^a-zA-Z0-9.]/g, "_");
        const path = `${curClass}/${Date.now()}_${cleanName}`;
        await _supabase.storage.from('exercise-files').upload(path, file);
        const { data: urlData } = _supabase.storage.from('exercise-files').getPublicUrl(path);
        await _supabase.from('exercises').insert([{
            class: document.getElementById("aClass").value,
            subject: document.getElementById("aSubject").value,
            title: title,
            file_url: urlData.publicUrl,
            file_path: path,
            file_type: file.type.startsWith("image") ? "img" : "doc"
        }]);
        alert("Exercice ajout√© avec succ√®s !");
        location.reload();
    } catch(err) { 
        alert("Erreur : " + err.message); 
        btn.innerText = "üöÄ Envoyer l'exercice"; 
        btn.disabled = false; 
    }
}

// Initialisation des menus d√©roulants Admin
const cSel = document.getElementById("aClass");
const sSel = document.getElementById("aSubject");
classesList.forEach(c => cSel.add(new Option(c,c)));
matieres.forEach(m => sSel.add(new Option(m,m)));

// Lancement de l'animation puis du site
window.addEventListener('load', () => {
    // Retirer l'animation apr√®s un d√©lai
    setTimeout(() => {
        document.getElementById('welcome-animation').classList.add('fade-out');
        // Charger le contenu du site une fois l'animation termin√©e
        loadClasses();
    }, 1000); // L'animation dure 1 seconde avant de commencer √† dispara√Ætre
});
</script>
</body>
</html>

