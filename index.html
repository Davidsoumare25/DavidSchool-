<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DavidSchool Pro v20</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p: #1e90ff; --s: #6a00ff; --bg: #f0f2f5; --card: #ffffff; --txt: #1c1e21; }
        @media (prefers-color-scheme: dark) { :root { --bg: #18191a; --card: #242526; --txt: #e4e6eb; } }
        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--txt); }
        
        header { background: linear-gradient(135deg, var(--p), var(--s)); color: white; padding: 25px; text-align: center; border-radius: 0 0 20px 20px; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: 1fr; gap: 15px; padding: 15px; max-width: 500px; margin: auto; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }
        .btn { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; background: var(--p); color: white; margin-top: 10px; transition: 0.2s; }
        .btn-red { background: #ff4757; }
        .btn-sec { background: var(--s); }
        .hidden { display: none !important; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; background: var(--card); color: var(--txt); }
        
        /* Design des dossiers */
        .folder { display: flex; align-items: center; background: var(--card); padding: 15px; border-radius: 12px; border-left: 6px solid var(--p); cursor: pointer; font-weight: bold; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .announcement-banner { background: #fff9db; border: 1px solid #fab005; color: #856404; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; line-height: 1.4; }
        .nav-bar { display: flex; justify-content: space-between; padding: 10px 15px; align-items: center; }
    </style>
</head>
<body>

    <div id="scr-auth" class="grid" style="margin-top: 40px;">
        <div class="card" style="text-align: center;">
            <h1 style="color: var(--p); margin-bottom: 5px;">DavidSchool</h1>
            <p style="font-size: 14px; color: gray;">Plateforme d'apprentissage</p>
            <input type="text" id="u-name" placeholder="Nom d'utilisateur">
            <input type="password" id="u-pass" placeholder="Mot de passe">
            <div id="reg-box" class="hidden">
                <select id="u-role"><option value="student">üë®‚Äçüéì √âl√®ve</option><option value="teacher">üë®‚Äçüè´ Professeur</option></select>
                <input type="text" id="u-code" placeholder="Code (ex: MATH10)">
            </div>
            <button class="btn" onclick="handleAuth()" id="btn-auth">Se connecter</button>
            <p onclick="toggleAuth()" style="font-size: 13px; cursor: pointer; text-decoration: underline; margin-top: 15px;">Pas de compte ? S'inscrire</p>
        </div>
    </div>

    <div id="scr-prof" class="hidden">
        <header>
            <div style="position:absolute; right:20px; top:20px;" onclick="location.reload()">Logout üö™</div>
            <h2>Tableau de Bord Prof</h2>
        </header>
        <div class="grid">
            <div class="card">
                <h3>üì§ Nouvelle Publication</h3>
                <input type="text" id="p-title" placeholder="Nom du document (ex: Cours PDF)">
                <textarea id="p-ann" placeholder="Message ou consigne pour les √©l√®ves..."></textarea>
                <select id="p-class"><option>6e</option><option>5e</option><option>4e</option><option>3e</option></select>
                <select id="p-sub"><option>MATHS</option><option>SVT</option><option>PC</option><option>HISTOIRE-G√âO</option></select>
                <input type="file" id="p-file">
                <button class="btn" onclick="upload()" id="btn-pub">üöÄ Mettre en ligne</button>
            </div>
            <div id="prof-list"></div>
            <button class="btn btn-red" onclick="deleteAccount()" style="margin-top: 30px;">‚ö†Ô∏è Supprimer mon compte</button>
        </div>
    </div>

    <div id="scr-student" class="hidden">
        <header>
            <div style="position:absolute; right:20px; top:20px;" onclick="location.reload()">üö™</div>
            <h2 id="stu-title">Mes Classes</h2>
        </header>

        <div id="view-teachers" class="grid"></div>

        <div id="view-classes" class="grid hidden">
            <div class="nav-bar"><span onclick="showTeachers()" style="cursor:pointer">‚¨Ö Retour</span></div>
            <div id="classes-list"></div>
        </div>

        <div id="view-subs" class="grid hidden">
            <div class="nav-bar"><span onclick="showClassesNav()" style="cursor:pointer">‚¨Ö Retour</span></div>
            <div id="subs-list"></div>
        </div>

        <div id="view-files" class="grid hidden">
            <div class="nav-bar"><span onclick="showSubsNav()" style="cursor:pointer">‚¨Ö Retour</span></div>
            <div id="files-list"></div>
        </div>
        
        <div class="grid"><button class="btn btn-red" onclick="deleteAccount()">Supprimer mon compte</button></div>
    </div>

<script>
    const S_URL = "https://lqevweyhxkvnckhtfpwh.supabase.co";
    const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxZXZ3ZXloeGt2bmNraHRmcHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTk2NTIsImV4cCI6MjA4NTYzNTY1Mn0.F6EUcdco3mn8AxlR9CMzxCmcxL-5-BypAhSak0JQSWw";
    const _db = supabase.createClient(S_URL, S_KEY);

    let user = null, isLogin = true, curCode = "", curClass = "", curSub = "";

    function toggleAuth() { isLogin = !isLogin; document.getElementById('reg-box').classList.toggle('hidden', isLogin); document.getElementById('btn-auth').innerText = isLogin ? "Se connecter" : "Cr√©er le compte"; }

    async function handleAuth() {
        const n = document.getElementById('u-name').value.trim(), p = document.getElementById('u-pass').value;
        if(isLogin) {
            const { data } = await _db.from('users_profile').select('*').eq('full_name', n).eq('password', p).maybeSingle();
            if(!data) return alert("Erreur d'identifiants");
            user = data; start();
        } else {
            const r = document.getElementById('u-role').value, c = document.getElementById('u-code').value.trim();
            const { error } = await _db.from('users_profile').insert([{ full_name:n, password:p, role:r, class_code:[c] }]);
            if(error) return alert("Ce nom existe d√©j√†");
            alert("Compte cr√©√© !"); location.reload();
        }
    }

    function start() {
        document.getElementById('scr-auth').classList.add('hidden');
        if(user.role === 'teacher') { document.getElementById('scr-prof').classList.remove('hidden'); loadProfDocs(); }
        else { document.getElementById('scr-student').classList.remove('hidden'); renderTeachers(); }
    }

    async function deleteAccount() {
        if(confirm("Es-tu s√ªr de vouloir supprimer ton compte d√©finitivement ?")) {
            await _db.from('users_profile').delete().eq('id', user.id);
            alert("Compte supprim√©."); location.reload();
        }
    }

    // --- LOGIQUE PROF ---
    async function upload() {
        const f = document.getElementById('p-file').files[0], t = document.getElementById('p-title').value, a = document.getElementById('p-ann').value;
        if(!f || !t) return alert("Titre et fichier obligatoires");
        const b = document.getElementById('btn-pub'); b.innerText = "‚è≥ Chargement...";
        const name = Date.now() + "_" + f.name.replace(/\s/g, "_");
        await _db.storage.from('exercise-files').upload(name, f);
        const { data: u } = _db.storage.from('exercise-files').getPublicUrl(name);
        
        await _db.from('exercises').insert([{
            professor_id: user.full_name, title: t, announcement: a,
            class: document.getElementById('p-class').value, subject: document.getElementById('p-sub').value,
            file_url: u.publicUrl, class_code: user.class_code[0]
        }]);
        alert("Publi√© avec succ√®s !"); loadProfDocs(); b.innerText = "üöÄ Mettre en ligne";
    }

    async function loadProfDocs() {
        const { data } = await _db.from('exercises').select('*').eq('class_code', user.class_code[0]).order('created_at', { ascending: false });
        const list = document.getElementById('prof-list');
        list.innerHTML = "<h4>Vos publications r√©centes :</h4>";
        data.forEach(d => { list.innerHTML += `<div class="card" style="margin-bottom:10px"><b>${d.class}</b> - ${d.title} <button onclick="delDoc('${d.id}')" style="float:right; color:red; border:none; background:none; cursor:pointer">üóëÔ∏è Supprimer</button></div>`; });
    }

    async function delDoc(id) { if(confirm("Supprimer ce document ?")) { await _db.from('exercises').delete().eq('id', id); loadProfDocs(); } }

    // --- LOGIQUE √âL√àVE ---
    function renderTeachers() {
        const div = document.getElementById('view-teachers'); div.innerHTML = "<h3>Choisir un Professeur</h3>";
        user.class_code.forEach(c => { div.innerHTML += `<div class="folder" onclick="openTeacher('${c}')">üìÅ Prof : ${c}</div>`; });
    }

    function openTeacher(code) { curCode = code; showClassesNav(); }
    function showClassesNav() { hideAllNav(); document.getElementById('view-classes').classList.remove('hidden'); 
        const div = document.getElementById('classes-list'); div.innerHTML = "<h3>Choisir la Classe</h3>";
        ["6e","5e","4e","3e"].forEach(cl => { div.innerHTML += `<div class="folder" onclick="openClass('${cl}')">üìÇ Classe de ${cl}</div>`; });
    }
    function openClass(cl) { curClass = cl; showSubsNav(); }
    function showSubsNav() { hideAllNav(); document.getElementById('view-subs').classList.remove('hidden');
        const div = document.getElementById('subs-list'); div.innerHTML = "<h3>Mati√®res disponibles</h3>";
        ["MATHS","SVT","PC","HISTOIRE-G√âO"].forEach(s => { div.innerHTML += `<div class="folder" onclick="openSub('${s}')">üìñ ${s}</div>`; });
    }
    function openSub(s) { curSub = s; showFilesNav(); }

    async function showFilesNav() {
        hideAllNav(); document.getElementById('view-files').classList.remove('hidden');
        const div = document.getElementById('files-list'); div.innerHTML = "Recherche des documents...";
        const { data } = await _db.from('exercises').select('*').eq('class_code', curCode).eq('class', curClass).eq('subject', curSub).order('created_at', { ascending: false });
        div.innerHTML = data.length ? "" : "<p>Aucun document trouv√©.</p>";
        data.forEach(f => {
            let ann = f.announcement ? `<div class="announcement-banner"><b>Message du prof :</b><br>${f.announcement}</div>` : "";
            div.innerHTML += `<div class="card" style="margin-bottom:15px;">
                ${ann}
                <h4 style="margin:10px 0;">${f.title}</h4>
                <a href="${f.file_url}" target="_blank" download class="btn btn-sec" style="display:block; text-align:center; text-decoration:none;">üì• T√©l√©charger / Voir</a>
            </div>`;
        });
    }

    function hideAllNav() { ['view-teachers','view-classes','view-subs','view-files'].forEach(id => document.getElementById(id).classList.add('hidden')); }
    function showTeachers() { hideAllNav(); document.getElementById('view-teachers').classList.remove('hidden'); }
</script>
</body>
</html>

