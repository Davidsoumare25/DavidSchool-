<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DavidSchool</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: #f2f4f8; overflow-x: hidden; }

        /* --- √âCRAN DE BIENVENUE "PREMIUM" --- */
        #splash-screen {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #1e004e 0%, #6a00ff 50%, #1e90ff 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 5000; transition: transform 0.8s cubic-bezier(0.65, 0, 0.35, 1);
        }
        .splash-content { text-align: center; color: white; animation: fadeIn 1s ease-out; }
        .splash-logo { width: 120px; height: 120px; border-radius: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .splash-title { font-size: 32px; font-weight: bold; margin: 10px 0; letter-spacing: 2px; }
        .splash-welcome { font-size: 18px; opacity: 0.9; margin-bottom: 30px; }
        
        /* Barre de chargement style mobile */
        .loader-bar { width: 200px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 10px; margin: auto; overflow: hidden; }
        .loader-progress { width: 0%; height: 100%; background: white; animation: load 2s forwards; }

        @keyframes load { to { width: 100%; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hide-splash { transform: translateY(-100%); }

        /* --- STYLE DU SITE --- */
        header { background: linear-gradient(135deg, #6a00ff, #1e90ff); color: white; padding: 40px 20px; text-align: center; position: relative; }
        .header-logo { height: 60px; border-radius: 12px; margin-bottom: 10px; }
        #adminTrigger { position: absolute; top: 20px; left: 20px; width: 40px; height: 40px; background: rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); }
        
        main { padding: 20px; max-width: 500px; margin: auto; }
        .grid { display: flex; flex-direction: column; gap: 12px; }
        .card { padding: 22px; border-radius: 15px; color: white; font-weight: bold; font-size: 18px; cursor: pointer; background: linear-gradient(90deg, #6a00ff, #1e90ff); box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: 0.2s; border: none; text-transform: uppercase; text-align: left; }
        .card:active { transform: scale(0.98); }

        /* --- PANEL ADMIN & SUPPRESSION --- */
        #adminModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; padding: 20px; align-items: center; justify-content: center; }
        .admin-box { background: white; width: 100%; max-width: 400px; border-radius: 25px; padding: 25px; max-height: 85vh; overflow-y: auto; }
        .admin-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .btn-del { background: #ff4757; color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; }
        
        input, select, .btn-main { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; }
        .btn-main { background: #6a00ff; color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-close { background: #eee; color: #333; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-content">
            <img src="https://lqevweyhxkvnckhtfpwh.supabase.co/storage/v1/object/public/exercise-files/1769899198248.png" class="splash-logo">
            <div class="splash-welcome">Bienvenue dans</div>
            <div class="splash-title">DavidSchool</div>
            <div class="loader-bar"><div class="loader-progress"></div></div>
        </div>
    </div>

    <header>
        <div id="adminTrigger" onclick="openAdmin()">‚öôÔ∏è</div>
        <img src="https://lqevweyhxkvnckhtfpwh.supabase.co/storage/v1/object/public/exercise-files/1769899198248.png" class="header-logo">
        <h1 style="margin:0">DavidSchool</h1>
    </header>

    <main>
        <button id="backBtn" class="btn-main btn-close" style="display:none; margin-bottom: 15px;" onclick="goBack()">‚¨ÖÔ∏è Retour</button>
        <div id="classes" class="grid"></div>
        <div id="subjects" class="grid" style="display:none"></div>
        <div id="exercises" class="grid" style="display:none"></div>
    </main>

    <div id="adminModal">
        <div class="admin-box">
            <h2 id="admTitle">Acc√®s Admin</h2>
            <div id="loginArea">
                <input type="password" id="passInput" placeholder="Code secret">
                <button class="btn-main" onclick="checkPass()">Connexion</button>
                <button class="btn-main btn-close" onclick="closeAdmin()">Annuler</button>
            </div>
            <div id="adminPanel" style="display:none">
                <p><b>‚ûï Ajouter un exercice</b></p>
                <select id="selClass"></select>
                <select id="selSub"></select>
                <input id="inTitle" placeholder="Titre">
                <input type="file" id="inFile">
                <button class="btn-main" id="upBtn" onclick="upload()">üöÄ Envoyer</button>
                
                <hr style="margin:20px 0; opacity:0.2">
                <p><b>üóëÔ∏è G√©rer / Supprimer</b></p>
                <div id="adminList">Chargement...</div>
                
                <button class="btn-main btn-close" onclick="closeAdmin()" style="margin-top:20px">Quitter l'Admin</button>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const S_URL = "https://lqevweyhxkvnckhtfpwh.supabase.co";
    const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxZXZ3ZXloeGt2bmNraHRmcHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTk2NTIsImV4cCI6MjA4NTYzNTY1Mn0.F6EUcdco3mn8AxlR9CMzxCmcxL-5-BypAhSak0JQSWw";
    const _supabase = supabase.createClient(S_URL, S_KEY);

    const matieres = ["MATH", "PHYSIQUE-CHIMIE", "HISTOIRE", "G√âOGRAPHIE", "FRAN√áAIS", "SVT"];
    const classes = ["6e", "5e", "4e", "3e"];
    let curC="", curS="", isAdmin=false;

    // Lancement de l'animation
    window.addEventListener('load', () => {
        setTimeout(() => {
            document.getElementById('splash-screen').classList.add('hide-splash');
            renderClasses();
        }, 2500); // 2.5 secondes pour bien voir l'animation
    });

    function renderClasses() {
        const box = document.getElementById("classes");
        box.innerHTML = "";
        classes.forEach(c => {
            let b = document.createElement("button"); b.className = "card";
            b.innerText = c; b.onclick = () => { curC=c; renderSubjects(); };
            box.appendChild(b);
        });
        document.getElementById("classes").style.display="flex";
        document.getElementById("subjects").style.display="none";
        document.getElementById("exercises").style.display="none";
        document.getElementById("backBtn").style.display="none";
    }

    function renderSubjects() {
        const box = document.getElementById("subjects"); box.innerHTML = "";
        matieres.forEach(s => {
            let b = document.createElement("button"); b.className = "card";
            b.innerText = s; b.onclick = () => { curS=s; loadExercises(); };
            box.appendChild(b);
        });
        document.getElementById("classes").style.display="none";
        document.getElementById("subjects").style.display="flex";
        document.getElementById("backBtn").style.display="block";
    }

    async function loadExercises() {
        const box = document.getElementById("exercises");
        box.style.display="flex"; document.getElementById("subjects").style.display="none";
        box.innerHTML = "Chargement...";
        const { data } = await _supabase.from('exercises').select('*').eq('class', curC).eq('subject', curS);
        box.innerHTML = "";
        if(data.length > 0) {
            data.forEach(e => {
                let d = document.createElement("div"); d.style = "background:#333; color:white; padding:15px; border-radius:15px; margin-bottom:10px;";
                d.innerHTML = `<b>${e.title}</b><br>`;
                if(e.file_type === "img") {
                    d.innerHTML += `<img src="${e.file_url}" style="width:100%; border-radius:10px; margin-top:10px;">`;
                } else {
                    d.innerHTML += `<a href="${e.file_url}" target="_blank" style="color:#00d1ff; text-decoration:none; display:block; margin-top:10px;">üìÇ Ouvrir Document</a>`;
                }
                box.appendChild(d);
            });
        } else { box.innerHTML = "Aucun exercice."; }
    }

    function goBack() {
        if(document.getElementById("exercises").style.display === "flex") renderSubjects();
        else renderClasses();
    }

    // --- LOGIQUE ADMIN ---
    function openAdmin() { document.getElementById("adminModal").style.display="flex"; }
    function closeAdmin() { document.getElementById("adminModal").style.display="none"; }

    function checkPass() {
        if(document.getElementById("passInput").value === "1234") {
            isAdmin = true;
            document.getElementById("loginArea").style.display="none";
            document.getElementById("adminPanel").style.display="block";
            document.getElementById("admTitle").innerText = "Gestion DavidSchool";
            refreshAdminList();
        } else { alert("Code incorrect"); }
    }

    async function refreshAdminList() {
        const list = document.getElementById("adminList"); list.innerHTML = "Chargement...";
        const { data } = await _supabase.from('exercises').select('*').order('created_at', {ascending: false});
        list.innerHTML = "";
        data.forEach(e => {
            let row = document.createElement("div"); row.className="admin-item";
            row.innerHTML = `<span>[${e.class}] ${e.title}</span>`;
            let b = document.createElement("button"); b.className="btn-del"; b.innerText="Suppr.";
            b.onclick = async () => {
                if(confirm("Supprimer ?")) {
                    await _supabase.from('exercises').delete().eq('id', e.id);
                    await _supabase.storage.from('exercise-files').remove([e.file_path]);
                    refreshAdminList();
                }
            };
            row.appendChild(b); list.appendChild(row);
        });
    }

    async function upload() {
        const file = document.getElementById("inFile").files[0];
        const title = document.getElementById("inTitle").value;
        const btn = document.getElementById("upBtn");
        if(!file || !title) return alert("Champs vides");
        
        btn.innerText = "‚è≥ Envoi..."; btn.disabled = true;
        const cleanName = file.name.replace(/[^a-zA-Z0-9.]/g, "_");
        const path = `${document.getElementById("selClass").value}/${Date.now()}_${cleanName}`;
        
        await _supabase.storage.from('exercise-files').upload(path, file);
        const { data: urlData } = _supabase.storage.from('exercise-files').getPublicUrl(path);
        
        await _supabase.from('exercises').insert([{
            class: document.getElementById("selClass").value,
            subject: document.getElementById("selSub").value,
            title: title,
            file_url: urlData.publicUrl,
            file_path: path,
            file_type: file.type.startsWith("image") ? "img" : "doc"
        }]);
        
        alert("Ajout√© !"); refreshAdminList();
        btn.innerText = "üöÄ Envoyer"; btn.disabled = false;
    }

    classes.forEach(c => document.getElementById("selClass").add(new Option(c,c)));
    matieres.forEach(m => document.getElementById("selSub").add(new Option(m,m)));
</script>
</body>
</html>

