<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DavidSchool Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #f2f4f8; --text: #222; --accent: #6a00ff; }
        .dark-mode { --bg: #121212; --text: #ffffff; --accent: #bb86fc; }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; transition: 0.3s; }
        body { margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; }

        /* Splash & News */
        #splash-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #1e004e, #1e90ff); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; }
        .hide-splash { transform: translateY(-100%); transition: 0.8s cubic-bezier(0.65, 0, 0.35, 1); }
        #news-bar { background: #ff4757; color: white; padding: 12px; overflow: hidden; white-space: nowrap; font-weight: bold; }
        .news-text { display: inline-block; animation: scroll 15s linear infinite; }
        @keyframes scroll { from { transform: translateX(100%); } to { transform: translateX(-100%); } }

        /* Header */
        header { background: linear-gradient(135deg, #1e004e, #6a00ff); color: white; padding: 35px 20px; text-align: center; position: relative; }
        .logo-img { height: 65px; border-radius: 15px; margin-bottom: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .top-btns { position: absolute; top: 15px; width: 100%; left: 0; padding: 0 20px; display: flex; justify-content: space-between; }
        .circle-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.4); font-size: 20px; }

        /* Content */
        .search-area { padding: 15px; max-width: 500px; margin: auto; }
        #searchInput { width: 100%; padding: 14px; border-radius: 30px; border: 1px solid #ddd; outline: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        main { padding: 15px; max-width: 500px; margin: auto; min-height: 60vh; }
        .grid { display: flex; flex-direction: column; gap: 15px; }
        .card { padding: 22px; border-radius: 18px; color: white; font-weight: bold; font-size: 18px; border: none; background: linear-gradient(90deg, #6a00ff, #1e90ff); text-align: left; cursor: pointer; position: relative; box-shadow: 0 4px 12px rgba(106, 0, 255, 0.2); }
        .card:active { transform: scale(0.97); }

        /* Admin Modal */
        #adminModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; padding: 20px; align-items: center; justify-content: center; }
        .admin-box { background: white; width: 100%; max-width: 420px; border-radius: 25px; padding: 25px; color: #333; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-x { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #999; }
        input, select, .btn-p { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; }
        .btn-p { background: #6a00ff; color: white; font-weight: bold; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-red { background: #ff4757; }
        .admin-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="https://lqevweyhxkvnckhtfpwh.supabase.co/storage/v1/object/public/exercise-files/1769899198248.png" style="width:90px; border-radius:20px;">
        <h2 style="color:white; letter-spacing: 2px;">DavidSchool</h2>
    </div>

    <div id="news-bar"><div class="news-text" id="newsMsg">Chargement des infos en cours...</div></div>

    <header>
        <div class="top-btns">
            <div class="circle-btn" onclick="openAdmin()">‚öôÔ∏è</div>
            <div class="circle-btn" onclick="toggleDark()">üåô</div>
        </div>
        <img src="https://lqevweyhxkvnckhtfpwh.supabase.co/storage/v1/object/public/exercise-files/1769899198248.png" class="logo-img">
        <h1 style="margin:0; font-size: 26px;">DavidSchool</h1>
    </header>

    <div class="search-area" id="searchContainer" style="display:none">
        <input type="text" id="searchInput" placeholder="üîç Rechercher un exercice..." onkeyup="doSearch()">
    </div>

    <main>
        <button id="backBtn" class="btn-p" style="display:none; background:#888; margin-bottom:20px;" onclick="handleBack()">‚¨ÖÔ∏è Retour aux mati√®res</button>
        <div id="classes" class="grid"></div>
        <div id="subjects" class="grid" style="display:none"></div>
        <div id="exercises" class="grid" style="display:none"></div>
    </main>

    <div id="adminModal">
        <div class="admin-box">
            <div class="close-x" onclick="closeAdmin()">√ó</div>
            <h3 id="admTitle">Espace Admin</h3>
            
            <div id="loginArea">
                <input type="password" id="admPass" placeholder="Entrez le code secret">
                <button class="btn-p" onclick="login()">Se connecter</button>
            </div>

            <div id="adminPanel" style="display:none">
                <p><b>üì¢ Message d√©filant</b></p>
                <input id="inpNews" placeholder="√âcrire l'annonce ici...">
                <button class="btn-p" onclick="saveNews()" style="background:#2ed573">Mettre √† jour l'annonce</button>
                <hr>
                <p><b>üì§ Ajouter un exercice</b></p>
                <select id="sClass"></select>
                <select id="sSub"></select>
                <input id="iTitle" placeholder="Titre de l'exercice">
                <input type="file" id="iFile">
                <button class="btn-p" id="upBtn" onclick="upload()">üöÄ Publier</button>
                <hr>
                <p><b>üóëÔ∏è Gestion des fichiers</b></p>
                <div id="admList"></div>
                <button class="btn-p btn-red" style="margin-top:20px" onclick="closeAdmin()">Quitter l'Admin</button>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURATION SUPABASE ---
    const S_URL = "https://lqevweyhxkvnckhtfpwh.supabase.co";
    const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxZXZ3ZXloeGt2bmNraHRmcHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTk2NTIsImV4cCI6MjA4NTYzNTY1Mn0.F6EUcdco3mn8AxlR9CMzxCmcxL-5-BypAhSak0JQSWw";
    const _supabase = supabase.createClient(S_URL, S_KEY);

    const matieres = ["MATH", "PHYSIQUE-CHIMIE", "HISTOIRE", "G√âOGRAPHIE", "FRAN√áAIS", "SVT"];
    const classes = ["6e", "5e", "4e", "3e"];
    let curC="", curS="", allEx=[];

    window.onload = async () => {
        loadNews();
        renderClasses();
        setTimeout(() => document.getElementById('splash-screen').classList.add('hide-splash'), 2200);
    };

    // Gestion de l'annonce
    async function loadNews() {
        try {
            const { data } = await _supabase.from('settings').select('value').eq('key', 'announcement').single();
            document.getElementById('newsMsg').innerText = data ? data.value : "Bienvenue sur DavidSchool !";
        } catch (e) {
            document.getElementById('newsMsg').innerText = "DavidSchool : Votre r√©ussite commence ici.";
        }
    }

    async function saveNews() {
        const val = document.getElementById('inpNews').value;
        if(!val) return alert("Le message est vide.");
        const { error } = await _supabase.from('settings').upsert({ key: 'announcement', value: val });
        if(!error) { alert("Annonce synchronis√©e !"); loadNews(); }
    }

    // Navigation
    function renderClasses() {
        curC = ""; curS = "";
        document.getElementById("classes").style.display="flex";
        document.getElementById("subjects").style.display="none";
        document.getElementById("exercises").style.display="none";
        document.getElementById("backBtn").style.display="none";
        document.getElementById("searchContainer").style.display="none";
        const box = document.getElementById("classes"); box.innerHTML = "";
        classes.forEach(c => {
            let b = document.createElement("button"); b.className="card"; b.innerText="Classe de " + c;
            b.onclick = () => { curC=c; renderSubjects(); };
            box.appendChild(b);
        });
    }

    function renderSubjects() {
        document.getElementById("classes").style.display="none";
        document.getElementById("exercises").style.display="none";
        document.getElementById("subjects").style.display="flex";
        document.getElementById("backBtn").style.display="block";
        document.getElementById("backBtn").innerText = "‚¨ÖÔ∏è Retour aux classes";
        const box = document.getElementById("subjects"); box.innerHTML = "";
        matieres.forEach(s => {
            let b = document.createElement("button"); b.className="card"; b.innerText=s;
            b.onclick = () => { curS=s; loadEx(); };
            box.appendChild(b);
        });
    }

    function handleBack() {
        if(document.getElementById("exercises").style.display === "flex") renderSubjects();
        else renderClasses();
    }

    // Exercices et recherche
    async function loadEx() {
        document.getElementById("subjects").style.display="none";
        document.getElementById("exercises").style.display="flex";
        document.getElementById("searchContainer").style.display="block";
        document.getElementById("backBtn").innerText = "‚¨ÖÔ∏è Retour aux mati√®res";
        const box = document.getElementById("exercises"); box.innerHTML = "Chargement des cours...";
        const { data } = await _supabase.from('exercises').select('*').eq('class', curC).eq('subject', curS);
        allEx = data || [];
        showList(allEx);
    }

    function showList(list) {
        const box = document.getElementById("exercises"); box.innerHTML = "";
        if(list.length === 0) { box.innerHTML = "<p style='text-align:center;opacity:0.6;'>Aucun exercice trouv√© pour le moment.</p>"; return; }
        list.forEach(e => {
            let d = document.createElement("div"); d.className="card"; d.style.background="#2a2a2a";
            d.innerHTML = `<span style="font-size:12px;opacity:0.8;">${e.subject}</span><br><b>${e.title}</b><br>`;
            if(e.file_type === "img") d.innerHTML += `<img src="${e.file_url}" style="width:100%; margin-top:12px; border-radius:12px; border:1px solid #444;">`;
            else d.innerHTML += `<a href="${e.file_url}" target="_blank" style="color:#00d1ff; display:inline-block; margin-top:12px; text-decoration:none; font-size:14px;">üìÇ Cliquer pour ouvrir le PDF</a>`;
            box.appendChild(d);
        });
    }

    function doSearch() {
        const q = document.getElementById("searchInput").value.toLowerCase();
        const res = allEx.filter(e => e.title.toLowerCase().includes(q));
        showList(res);
    }

    // Fonctions Admin
    function openAdmin() { document.getElementById("adminModal").style.display="flex"; }
    function closeAdmin() { 
        document.getElementById("adminModal").style.display="none"; 
        document.getElementById("admPass").value = "";
    }

    function login() {
        if(document.getElementById("admPass").value === "1234") {
            document.getElementById("loginArea").style.display="none";
            document.getElementById("adminPanel").style.display="block";
            refreshAdmList();
        } else { alert("Code secret erron√©."); }
    }

    async function upload() {
        const f = document.getElementById("iFile").files[0];
        const t = document.getElementById("iTitle").value;
        const c = document.getElementById("sClass").value;
        const s = document.getElementById("sSub").value;
        if(!f || !t) return alert("Veuillez remplir tous les champs.");
        
        document.getElementById("upBtn").innerText = "‚è≥ Envoi en cours...";
        const path = `${c}/${Date.now()}_${f.name}`;
        await _supabase.storage.from('exercise-files').upload(path, f);
        const { data: u } = _supabase.storage.from('exercise-files').getPublicUrl(path);
        await _supabase.from('exercises').insert([{ class:c, subject:s, title:t, file_url:u.publicUrl, file_path:path, file_type:f.type.startsWith("image")?"img":"doc" }]);
        
        alert("L'exercice est en ligne !");
        document.getElementById("upBtn").innerText = "üöÄ Publier";
        refreshAdmList();
    }

    async function refreshAdmList() {
        const { data } = await _supabase.from('exercises').select('*').order('created_at',{ascending:false});
        const box = document.getElementById("admList"); box.innerHTML = "<b>Gestion des exercices :</b><br>";
        data.forEach(e => {
            let row = document.createElement("div"); row.className = "admin-list-item";
            row.innerHTML = `<span>[${e.class}] ${e.title}</span> <button onclick="del('${e.id}','${e.file_path}')" style="color:#ff4757; border:none; background:none; cursor:pointer; font-weight:bold;">Supprimer</button>`;
            box.appendChild(row);
        });
    }

    async function del(id, p) {
        if(confirm("Supprimer cet exercice d√©finitivement ?")) {
            await _supabase.from('exercises').delete().eq('id', id);
            await _supabase.storage.from('exercise-files').remove([p]);
            refreshAdmList();
        }
    }

    function toggleDark() { document.body.classList.toggle('dark-mode'); }
    classes.forEach(c => document.getElementById("sClass").add(new Option(c,c)));
    matieres.forEach(m => document.getElementById("sSub").add(new Option(m,m)));
</script>
</body>
</html>

