<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DavidSchool Pro v26</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p: #1e90ff; --s: #6a00ff; --bg: #0f0f10; --card: #1c1c1e; --txt: #ffffff; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--txt); padding-bottom: 70px; }
        header { background: linear-gradient(135deg, var(--s), var(--p)); color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 12px; padding: 15px; max-width: 450px; margin: auto; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #333; }
        .folder { display: flex; align-items: center; justify-content: space-between; background: #2c2c2e; padding: 15px; border-radius: 10px; cursor: pointer; margin-bottom: 8px; border-left: 4px solid var(--p); }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: var(--p); color: white; }
        .hidden { display: none !important; }
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #333; background: #2c2c2e; color: white; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1c1c1e; display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid #333; }
        .nav-item { cursor: pointer; opacity: 0.5; font-size: 12px; text-align: center; }
        .nav-item.active { opacity: 1; color: var(--p); }
        .badge { background: #ff4757; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
    </style>
</head>
<body>

    <div id="scr-auth" class="grid" style="margin-top: 40px;">
        <div class="card" style="text-align: center;">
            <h1 style="color:var(--p)">DavidSchool</h1>
            <input type="text" id="u-name" placeholder="Nom d'utilisateur">
            <input type="password" id="u-pass" placeholder="Mot de passe">
            <div id="reg-box" class="hidden">
                <select id="u-role"><option value="student">√âl√®ve</option><option value="teacher">Professeur</option></select>
                <input type="text" id="u-code" placeholder="Code unique (ex: Cool)">
            </div>
            <button class="btn" onclick="handleAuth()">Se connecter</button>
            <p onclick="toggleAuth()" style="font-size: 13px; cursor: pointer; color: gray; margin-top: 15px;">Cr√©er un compte</p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header><h2 id="header-title">Mes Cours</h2></header>

        <div id="tab-home">
            <div id="prof-ui" class="grid hidden">
                <div class="card">
                    <h3>üì§ Publier</h3>
                    <input type="text" id="p-title" placeholder="Titre (ex: Trigonom√©trie)">
                    <textarea id="p-ann" placeholder="Instructions..."></textarea>
                    <select id="p-class"><option>6e</option><option>5e</option><option>4e</option><option>3e</option></select>
                    <select id="p-sub"><option>FRAN√áAIS</option><option>MATHS</option><option>SVT</option><option>PC</option><option>HG</option></select>
                    <input type="file" id="p-file">
                    <button class="btn" onclick="upload()">üöÄ Lancer la publication</button>
                </div>
                <div id="prof-list"></div>
            </div>

            <div id="stu-ui" class="hidden">
                <div id="step-teachers" class="grid"></div>
                <div id="step-classes" class="grid hidden"><div id="list-classes"></div></div>
                <div id="step-subs" class="grid hidden"><div id="list-subs"></div></div>
                <div id="step-files" class="grid hidden"><div id="list-files"></div></div>
            </div>
        </div>

        <div id="tab-account" class="grid hidden">
            <div class="card">
                <h3>üë§ Mon Profil</h3>
                <p>Nom : <b id="display-name"></b></p>
                <p>Mes acc√®s : <span id="display-codes"></span></p>
                <div id="stu-add" class="hidden">
                    <input type="text" id="add-code" placeholder="Ajouter un code prof">
                    <button class="btn" onclick="addCode()">Rejoindre une classe</button>
                </div>
                <button class="btn" style="background: #ff4757; margin-top: 20px;" onclick="deleteAccount()">Supprimer mon compte</button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" id="btn-h" onclick="switchTab('home')">üè†<br>Cours</div>
            <div class="nav-item" id="btn-a" onclick="switchTab('account')">üë§<br>Compte</div>
            <div class="nav-item" onclick="location.reload()">üö™<br>Sortir</div>
        </div>
    </div>

<script>
    const S_URL = "https://lqevweyhxkvnckhtfpwh.supabase.co";
    const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxZXZ3ZXloeGt2bmNraHRmcHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTk2NTIsImV4cCI6MjA4NTYzNTY1Mn0.F6EUcdco3mn8AxlR9CMzxCmcxL-5-BypAhSak0JQSWw";
    const _db = supabase.createClient(S_URL, S_KEY);

    let user = null, isLogin = true, selCode="", selClass="", selSub="";

    function toggleAuth() { isLogin = !isLogin; document.getElementById('reg-box').classList.toggle('hidden', isLogin); }

    async function handleAuth() {
        const n = document.getElementById('u-name').value.trim(), p = document.getElementById('u-pass').value;
        if(isLogin) {
            const { data } = await _db.from('users_profile').select('*').eq('full_name', n).eq('password', p).maybeSingle();
            if(!data) return alert("Erreur d'identification");
            user = data; startApp();
        } else {
            const r = document.getElementById('u-role').value, c = document.getElementById('u-code').value.trim();
            if(!c) return alert("Code requis");
            await _db.from('users_profile').insert([{ full_name:n, password:p, role:r, class_code:[c] }]);
            alert("Compte pr√™t !"); location.reload();
        }
    }

    function startApp() {
        document.getElementById('scr-auth').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('display-name').innerText = user.full_name;
        document.getElementById('display-codes').innerText = user.class_code.join(', ');
        if(user.role === 'teacher') {
            document.getElementById('prof-ui').classList.remove('hidden');
            loadProfDocs();
        } else {
            document.getElementById('stu-ui').classList.remove('hidden');
            document.getElementById('stu-add').classList.remove('hidden');
            renderTeachers();
        }
    }

    function switchTab(t) {
        document.getElementById('tab-home').classList.toggle('hidden', t !== 'home');
        document.getElementById('tab-account').classList.toggle('hidden', t !== 'account');
        document.getElementById('btn-h').classList.toggle('active', t === 'home');
        document.getElementById('btn-a').classList.toggle('active', t === 'account');
    }

    // --- LOGIQUE PROF ---
    async function upload() {
        const f = document.getElementById('p-file').files[0], t = document.getElementById('p-title').value;
        if(!f || !t) return alert("Titre et fichier obligatoires");
        const path = Date.now() + "_" + f.name.replace(/\s/g, "_");
        const { error: stErr } = await _db.storage.from('exercise-files').upload(path, f);
        if(stErr) return alert("Erreur stockage: " + stErr.message);
        
        const url = _db.storage.from('exercise-files').getPublicUrl(path).data.publicUrl;
        const { error: dbErr } = await _db.from('exercises').insert([{
            title: t, announcement: document.getElementById('p-ann').value,
            class: document.getElementById('p-class').value,
            subject: document.getElementById('p-sub').value,
            file_url: url, class_code: user.class_code[0]
        }]);
        
        if(dbErr) alert("Erreur base: " + dbErr.message);
        else { alert("Document publi√© avec succ√®s !"); loadProfDocs(); }
    }

    async function loadProfDocs() {
        const { data } = await _db.from('exercises').select('*').eq('class_code', user.class_code[0]).order('created_at', { ascending: false });
        const list = document.getElementById('prof-list');
        list.innerHTML = "<h4>Vos publications r√©centes :</h4>";
        data.forEach(d => {
            list.innerHTML += `<div class="card" style="margin-top:8px"><b>${d.title}</b> [${d.class}] <button onclick="delDoc('${d.id}')" style="float:right; color:red; background:none; border:none; cursor:pointer">üóëÔ∏è</button></div>`;
        });
    }
    async function delDoc(id) { if(confirm("Supprimer ce document ?")) { await _db.from('exercises').delete().eq('id', id); loadProfDocs(); } }

    // --- LOGIQUE ELEVE ---
    function showStep(s) { 
        ['step-teachers','step-classes','step-subs','step-files'].forEach(i => document.getElementById(i).classList.add('hidden')); 
        document.getElementById(s).classList.remove('hidden'); 
    }

    function renderTeachers() {
        const d = document.getElementById('step-teachers');
        d.innerHTML = "<h3>Choisir un Professeur</h3>";
        user.class_code.forEach(c => {
            d.innerHTML += `<div class="folder" onclick="selCode='${c}'; showStep('step-classes'); renderClasses();">üë®‚Äçüè´ Code Prof : ${c} ‚û°</div>`;
        });
    }

    function renderClasses() {
        const d = document.getElementById('list-classes');
        d.innerHTML = "<p onclick='showStep(\"step-teachers\")' style='cursor:pointer'>‚¨Ö Retour</p><h3>Choisir la Classe</h3>";
        ["6e","5e","4e","3e"].forEach(c => {
            d.innerHTML += `<div class="folder" onclick="selClass='${c}'; showStep('step-subs'); renderSubs();">üìÇ Classe de ${c} ‚û°</div>`;
        });
    }

    function renderSubs() {
        const d = document.getElementById('list-subs');
        d.innerHTML = "<p onclick='showStep(\"step-classes\")' style='cursor:pointer'>‚¨Ö Retour</p><h3>Choisir la Mati√®re</h3>";
        ["FRAN√áAIS","MATHS","SVT","PC","HG"].forEach(s => {
            d.innerHTML += `<div class="folder" onclick="selSub='${s}'; showStep('step-files'); renderFiles();">üìñ ${s} ‚û°</div>`;
        });
    }

    async function renderFiles() {
        const d = document.getElementById('list-files');
        d.innerHTML = "<p onclick='showStep(\"step-subs\")' style='cursor:pointer'>‚¨Ö Retour</p><h3>Documents trouv√©s</h3>";
        
        // RECHERCHE PR√âCISE
        const { data } = await _db.from('exercises').select('*').eq('class_code', selCode).eq('class', selClass).eq('subject', selSub).order('created_at', { ascending: false });

        if(!data || data.length === 0) {
            d.innerHTML += `<div style="color:#ff4757; padding:15px; border:1px dashed #ff4757; border-radius:10px; font-size:12px">
                ‚ö†Ô∏è Aucun document pour <b>${selSub}</b> en <b>${selClass}</b>.<br><br>
                <i>V√©rifiez que le prof a bien s√©lectionn√© ces options lors de la publication.</i>
            </div>`;
        } else {
            data.forEach(f => {
                d.innerHTML += `<div class="card" style="margin-top:10px">
                    ${f.announcement ? `<div style="color:#ffa500; font-size:13px; margin-bottom:8px">üì¢ ${f.announcement}</div>` : ''}
                    <h4 style="margin:0">${f.title}</h4>
                    <a href="${f.file_url}" target="_blank" class="btn" style="display:block; text-align:center; text-decoration:none; margin-top:10px">üì• T√©l√©charger / Ouvrir</a>
                </div>`;
            });
        }
    }

    async function addCode() {
        const c = document.getElementById('add-code').value.trim();
        if(!c || user.class_code.includes(c)) return;
        let codes = [...user.class_code, c];
        await _db.from('users_profile').update({ class_code: codes }).eq('id', user.id);
        alert("Nouveau professeur ajout√© !"); location.reload();
    }

    async function deleteAccount() { if(confirm("Supprimer votre compte DavidSchool ?")) { await _db.from('users_profile').delete().eq('id', user.id); location.reload(); } }
</script>
</body>
</html>

