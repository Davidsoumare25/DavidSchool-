<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DavidSchool Pro v23</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p: #1e90ff; --s: #6a00ff; --bg: #f4f7f6; --card: #ffffff; --txt: #333; }
        @media (prefers-color-scheme: dark) { :root { --bg: #1a1a1a; --card: #2d2d2d; --txt: #eee; } }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--txt); }
        header { background: linear-gradient(135deg, var(--s), var(--p)); color: white; padding: 25px; text-align: center; border-radius: 0 0 25px 25px; position: relative; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 12px; padding: 15px; max-width: 500px; margin: auto; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }
        .folder { display: flex; align-items: center; justify-content: space-between; background: var(--card); padding: 15px; border-radius: 10px; border-left: 6px solid var(--p); cursor: pointer; font-weight: bold; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: var(--p); color: white; margin-top: 8px; }
        .btn-red { background: #eb4d4b; }
        .hidden { display: none !important; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #ddd; background: var(--card); color: var(--txt); }
        .nav-back { color: var(--p); font-weight: bold; cursor: pointer; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>

    <div id="scr-auth" class="grid" style="margin-top: 50px;">
        <div class="card" style="text-align: center;">
            <h1 style="color: var(--p);">DavidSchool</h1>
            <input type="text" id="u-name" placeholder="Nom d'utilisateur">
            <input type="password" id="u-pass" placeholder="Mot de passe">
            <div id="reg-box" class="hidden">
                <select id="u-role"><option value="student">üë®‚Äçüéì √âl√®ve</option><option value="teacher">üë®‚Äçüè´ Professeur</option></select>
                <input type="text" id="u-code" placeholder="Code de classe (ex: Cool)">
            </div>
            <button class="btn" onclick="handleAuth()" id="btn-auth">Se connecter</button>
            <p onclick="toggleAuth()" style="font-size: 13px; cursor: pointer; text-decoration: underline; margin-top: 15px;">Cr√©er un compte</p>
        </div>
    </div>

    <div id="scr-prof" class="hidden">
        <header><div style="position:absolute; right:15px; top:15px;" onclick="location.reload()">üö™</div><h2>Espace Prof</h2></header>
        <div class="grid">
            <div class="card">
                <h3>üì§ Publier / Modifier</h3>
                <input type="hidden" id="edit-id">
                <input type="text" id="p-title" placeholder="Titre du cours">
                <textarea id="p-ann" placeholder="Annonce (optionnel)"></textarea>
                <select id="p-class"><option>6e</option><option>5e</option><option>4e</option><option>3e</option></select>
                <select id="p-sub"><option>FRAN√áAIS</option><option>MATHS</option><option>SVT</option><option>PC</option><option>HG</option></select>
                <input type="file" id="p-file">
                <button class="btn" onclick="upload()" id="btn-pub">üöÄ Publier</button>
                <button class="btn hidden" id="btn-cancel" onclick="cancelEdit()" style="background:gray">Annuler</button>
            </div>
            <div id="prof-list"></div>
            <hr>
            <div class="card">
                <h4>‚öôÔ∏è Mon Compte</h4>
                <input type="text" id="upd-name-p" placeholder="Nouveau nom">
                <button class="btn" onclick="updateAccount('p')">Modifier mon nom</button>
                <button class="btn btn-red" onclick="deleteAccount()">Supprimer mon compte</button>
            </div>
        </div>
    </div>

    <div id="scr-student" class="hidden">
        <header><div style="position:absolute; right:15px; top:15px;" onclick="location.reload()">üö™</div><h2>Espace √âl√®ve</h2></header>
        <div id="step-teachers" class="grid"></div>
        <div id="step-classes" class="grid hidden"><span class="nav-back" onclick="showStep('step-teachers')">‚¨Ö Retour</span><div id="list-classes"></div></div>
        <div id="step-subs" class="grid hidden"><span class="nav-back" onclick="showStep('step-classes')">‚¨Ö Retour</span><div id="list-subs"></div></div>
        <div id="step-files" class="grid hidden"><span class="nav-back" onclick="showStep('step-subs')">‚¨Ö Retour</span><div id="list-files"></div></div>
        
        <div class="grid">
            <div class="card">
                <h4>‚öôÔ∏è Mon Compte √âl√®ve</h4>
                <input type="text" id="upd-name-s" placeholder="Nouveau nom">
                <button class="btn" onclick="updateAccount('s')">Enregistrer</button>
                <button class="btn btn-red" onclick="deleteAccount()">Supprimer mon compte</button>
            </div>
        </div>
    </div>

<script>
    const S_URL = "https://lqevweyhxkvnckhtfpwh.supabase.co";
    const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxZXZ3ZXloeGt2bmNraHRmcHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTk2NTIsImV4cCI6MjA4NTYzNTY1Mn0.F6EUcdco3mn8AxlR9CMzxCmcxL-5-BypAhSak0JQSWw";
    const _db = supabase.createClient(S_URL, S_KEY);

    let user = null, isLogin = true, selCode="", selClass="", selSub="", isEdit=false;

    function toggleAuth() { isLogin = !isLogin; document.getElementById('reg-box').classList.toggle('hidden', isLogin); }

    async function handleAuth() {
        const n = document.getElementById('u-name').value.trim(), p = document.getElementById('u-pass').value;
        if(isLogin) {
            const { data } = await _db.from('users_profile').select('*').eq('full_name', n).eq('password', p).maybeSingle();
            if(!data) return alert("Identifiants incorrects");
            user = data; start();
        } else {
            const r = document.getElementById('u-role').value, c = document.getElementById('u-code').value.trim();
            if(!c) return alert("Le code est obligatoire !");
            await _db.from('users_profile').insert([{ full_name:n, password:p, role:r, class_code:[c] }]);
            alert("Compte cr√©√© !"); location.reload();
        }
    }

    function start() {
        document.getElementById('scr-auth').classList.add('hidden');
        if(user.role === 'teacher') { document.getElementById('scr-prof').classList.remove('hidden'); loadProfDocs(); }
        else { document.getElementById('scr-student').classList.remove('hidden'); renderTeachers(); }
    }

    // GESTION COMPTE
    async function updateAccount(suffix) {
        const newName = document.getElementById('upd-name-'+suffix).value.trim();
        if(!newName) return;
        await _db.from('users_profile').update({ full_name: newName }).eq('id', user.id);
        alert("Nom modifi√© ! Reconnectez-vous."); location.reload();
    }
    async function deleteAccount() {
        if(confirm("Supprimer d√©finitivement votre compte ?")) {
            await _db.from('users_profile').delete().eq('id', user.id);
            location.reload();
        }
    }

    // PROFESSEUR
    async function upload() {
        const f = document.getElementById('p-file').files[0], t = document.getElementById('p-title').value, id = document.getElementById('edit-id').value;
        if(!t) return alert("Titre manquant");
        const b = document.getElementById('btn-pub'); b.innerText = "‚è≥...";
        
        let url = null;
        if(f) {
            const path = Date.now() + "_" + f.name.replace(/\s/g, "_");
            await _db.storage.from('exercise-files').upload(path, f);
            url = _db.storage.from('exercise-files').getPublicUrl(path).data.publicUrl;
        }

        const obj = { title:t, announcement:document.getElementById('p-ann').value, class:document.getElementById('p-class').value, subject:document.getElementById('p-sub').value, class_code: user.class_code[0] };
        if(url) obj.file_url = url;

        if(isEdit) await _db.from('exercises').update(obj).eq('id', id);
        else await _db.from('exercises').insert([obj]);

        alert("Op√©ration r√©ussie !"); cancelEdit(); loadProfDocs();
    }

    async function loadProfDocs() {
        const { data } = await _db.from('exercises').select('*').eq('class_code', user.class_code[0]).order('created_at', { ascending: false });
        const list = document.getElementById('prof-list'); list.innerHTML = "<h4>Vos documents :</h4>";
        data.forEach(d => {
            list.innerHTML += `<div class="card"><b>${d.class} - ${d.title}</b><br><button onclick='prepEdit(${JSON.stringify(d)})'>‚úèÔ∏è</button> <button onclick="delDoc('${d.id}')">üóëÔ∏è</button></div>`;
        });
    }
    function prepEdit(d) { 
        isEdit=true; document.getElementById('edit-id').value=d.id; document.getElementById('p-title').value=d.title; 
        document.getElementById('p-ann').value=d.announcement; document.getElementById('btn-pub').innerText="Enregistrer";
        document.getElementById('btn-cancel').classList.remove('hidden');
    }
    function cancelEdit() { isEdit=false; document.getElementById('edit-id').value=""; document.getElementById('p-title').value=""; document.getElementById('btn-pub').innerText="Publier"; document.getElementById('btn-cancel').classList.add('hidden'); }
    async function delDoc(id) { if(confirm("Supprimer ?")) { await _db.from('exercises').delete().eq('id', id); loadProfDocs(); } }

    // ELEVE
    function showStep(s) { ['step-teachers','step-classes','step-subs','step-files'].forEach(i => document.getElementById(i).classList.add('hidden')); document.getElementById(s).classList.remove('hidden'); }
    function renderTeachers() {
        const d = document.getElementById('step-teachers'); d.innerHTML = "<h3>Profs</h3>";
        user.class_code.forEach(c => { d.innerHTML += `<div class="folder" onclick="selCode='${c}'; showStep('step-classes'); renderClasses();">üë®‚Äçüè´ ${c} ‚û°</div>`; });
    }
    function renderClasses() {
        const d = document.getElementById('list-classes'); d.innerHTML = "<h3>Classes</h3>";
        ["6e","5e","4e","3e"].forEach(c => { d.innerHTML += `<div class="folder" onclick="selClass='${c}'; showStep('step-subs'); renderSubs();">üìÇ ${c} ‚û°</div>`; });
    }
    function renderSubs() {
        const d = document.getElementById('list-subs'); d.innerHTML = "<h3>Mati√®res</h3>";
        ["FRAN√áAIS","MATHS","SVT","PC","HG"].forEach(s => { d.innerHTML += `<div class="folder" onclick="selSub='${s}'; showStep('step-files'); renderFiles();">üìñ ${s} ‚û°</div>`; });
    }
    async function renderFiles() {
        const d = document.getElementById('list-files'); d.innerHTML = "Chargement...";
        const { data } = await _db.from('exercises').select('*').eq('class_code', selCode).eq('class', selClass).eq('subject', selSub).order('created_at', { ascending: false });
        d.innerHTML = data.length ? "" : "Aucun document.";
        data.forEach(f => {
            d.innerHTML += `<div class="card">${f.announcement ? `<p>üì¢ ${f.announcement}</p>`:''}<h4>${f.title}</h4><a href="${f.file_url}" target="_blank" class="btn" style="display:block;text-align:center;text-decoration:none">Ouvrir</a></div>`;
        });
    }
</script>
</body>
</html>

